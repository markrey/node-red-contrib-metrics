<!--
  Copyright 2015 Atsushi Kojo.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="metrics graphics">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-column"><i class="fa fa-columns"></i> Column</label>
    <input type="text" id="node-input-column" style="width:200px">
    <div class="btn-group">
      <a title="play" class="btn chart-play" href="#">
        <i class="fa fa-play"></i>
      </a>
      <a title="pause" class="btn chart-pause" href="#">
        <i class="fa fa-pause"></i>
      </a>
      <a title="refresh" class="btn chart-refresh" href="#">
        <i class="fa fa-refresh"></i>
      </a>
      <a title="clear" class="btn chart-clear" href="#">
        <i class="fa fa-remove"></i>
      </a>
    </div>
  </div>
  <div class="form-row node-input-route-container-row" style="margin-bottom: 0px;">
    <div id="node-input-route-container-div" style="box-sizing: border-box; border-radius: 5px; height: 310px; padding: 5px; border: 1px solid #ccc; overflow-y:scroll;">
      <ol id="node-input-route-container" style=" list-style-type:none; margin: 0;"></ol>
    </div>
  </div>
  <div class="form-row">
    <a href="#" class="btn btn-mini" id="node-input-add-route" style="margin-top: 4px;"><i class="fa fa-plus"></i> route</a>
  </div>
</script>

<script type="text/x-red" data-help-name="metrics graphics">
  <p>chart</p>
</script>

<script type="text/javascript">

!function(t,e){t.MG = e(t.d3, t.jQuery);}(this,function(t,e){function r(t,e,r){MG.charts[t]={descriptor:e,defaults:r||{}}}function n(r){"use strict";var n=Rr(r.target);if(r.show_tooltips&&r.description?e(".mg-header").remove():Cr(n,".mg-header"),r.target&&r.title){var a=n.insert("text").attr("class","mg-header").attr("x",(r.width+r.left-r.right)/2).attr("y",r.title_y_position).attr("text-anchor","middle").attr("dy","0.55em");a.append("tspan").attr("class","mg-chart-title").text(r.title),r.show_tooltips&&r.description&&(a.append("tspan").attr("class","mg-chart-description").attr("dx","0.3em").text("ÔÅô"),e(a.node()).popover({html:!0,animation:!1,placement:"top",content:r.description,container:r.target,trigger:"manual",template:'<div class="popover mg-popover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>'}).on("mouseenter",function(){t.selectAll(r.target).selectAll(".mg-popover").remove(),e(this).popover("show"),e(r.target).select(".popover").on("mouseleave",function(){$chartTitle.popover("hide")})}).on("mouseleave",function(){setTimeout(function(){e(".popover:hover").length||$chartTitle.popover("hide")},120)})),a=null}r.error&&rn(r)}function a(t){"use strict";t.rug_buffer_size="point"===t.chart_type?t.buffer/2:2*t.buffer/3;var e=Er(t,"mg-y-rug");e.attr("x1",t.left+1).attr("x2",t.left+t.rug_buffer_size).attr("y1",t.scalefns.yf).attr("y2",t.scalefns.yf),Xr(e,t,"mg-y-rug-mono")}function o(e,r){return"bar"===e.chart_type&&(r.min=0,r.max=t.max(e.data[0],function(t){var r=[];return r.push(t[e.y_accessor]),null!==e.baseline_accessor&&r.push(t[e.baseline_accessor]),null!==e.predictor_accessor&&r.push(t[e.predictor_accessor]),Math.max.apply(null,r)})),r}function i(e){var r=e.yax_format;return r||("count"===e.format?(e.processed.max_y<1e-4?e.decimals=6:e.processed.max_y<.1&&(e.decimals=4),r=function(r){if(1>r)return e.yax_units+t.round(r,e.decimals);var n=t.formatPrefix(r);return e.yax_units+n.scale(r)+n.symbol}):r=function(e){var r=t.format("2p");return r(e)}),r}function s(e){var r=Br(e.data);"log"===e.y_scale_type&&(r=r.filter(function(t){return t[e.y_accessor]>0})),e.baselines&&(r=r.concat(e.baselines));var n=t.extent(r,function(t){return t[e.y_accessor]}),a={};a.min=n[0],a.max=n[1],a.min>=0&&!e.min_y&&!e.min_y_from_data&&(a.min=0),o(e,a),a.min=null!==e.min_y?e.min_y:a.min,a.max=null!==e.max_y?e.max_y:a.max<0?a.max+(a.max-a.max*e.inflator):a.max*e.inflator,"log"!==e.y_scale_type&&a.min<0&&(a.min=a.min-(a.min-a.min*e.inflator)),!e.min_y&&e.min_y_from_data&&(a.min=a.min/e.inflator),e.processed.min_y=a.min,e.processed.max_y=a.max}function l(t,e){return e.domain([t.processed.min_y,t.processed.max_y]).range([wr(t),t.top]),e}function c(e){var r="log"===e.y_scale_type?t.scale.log():t.scale.linear();"log"===e.y_scale_type&&("histogram"===e.chart_type?e.processed.min_y=.2:e.processed.min_y<=0&&(e.processed.min_y=1)),e.scales.Y=l(e,r),e.scales.Y.clamp("log"===e.y_scale_type),e.scales.Y_axis=l(e,t.scale.linear())}function u(t,e){e.y_label&&t.append("text").attr("class","label").attr("x",function(){return-1*(Mr(e)+(wr(e)-Mr(e))/2)}).attr("y",function(){return e.left/2}).attr("dy","0.4em").attr("text-anchor","middle").text(function(){return e.y_label}).attr("transform",function(){return"rotate(-90)"})}function f(t){function e(t){return 1e3===t?3:1e6===t?7:Math.log(t)/Math.LN10}var r=t.scales.Y.ticks(t.yax_count);"log"===t.y_scale_type&&(r=r.filter(function(t){return Math.abs(e(t))%1<1e-6||Math.abs(e(t))%1>1-1e-6}));var n=t.scales.Y.ticks(t.yax_count).length,a=!0;t.data.forEach(function(e){e.forEach(function(e){return e[t.y_accessor]%1!==0?(a=!1,!1):void 0})}),a&&n>t.processed.max_y&&"count"===t.format&&(r=r.filter(function(t){return t%1===0})),t.processed.y_ticks=r}function d(t,e){var r=e.processed.y_ticks.length;if(!e.x_extended_ticks&&!e.y_extended_ticks&&r){var n,a;e.axes_not_compact&&"bar"!==e.chart_type?(n=e.height-e.bottom,a=e.top):r?(n=e.scales.Y(e.processed.y_ticks[0]).toFixed(2),a=e.scales.Y(e.processed.y_ticks[r-1]).toFixed(2)):(n=0,a=0),t.append("line").attr("x1",e.left).attr("x2",e.left).attr("y1",n).attr("y2",a)}}function p(t,e){t.selectAll(".mg-yax-ticks").data(e.processed.y_ticks).enter().append("line").classed("mg-extended-y-ticks",e.y_extended_ticks).attr("x1",e.left).attr("x2",function(){return e.y_extended_ticks?e.width-e.right:e.left-e.yax_tick_length}).attr("y1",function(t){return e.scales.Y(t).toFixed(2)}).attr("y2",function(t){return e.scales.Y(t).toFixed(2)})}function m(t,e){var r=i(e);t.selectAll(".mg-yax-labels").data(e.processed.y_ticks).enter().append("text").attr("x",e.left-3*e.yax_tick_length/2).attr("dx",-3).attr("y",function(t){return e.scales.Y(t).toFixed(2)}).attr("dy",".35em").attr("text-anchor","end").text(function(t){var e=r(t);return e})}function h(t){t.processed||(t.processed={});var e=Rr(t.target);if(s(t),MG.call_hook("y_axis.process_min_max",t,t.processed.min_y,t.processed.max_y),c(t),Fr(t,"yf","Y",t.y_accessor),Yr(e,".mg-y-axis"),!t.y_axis)return this;var r=zr(e,"mg-y-axis");return u(r,t),f(t),d(r,t),p(r,t),m(r,t),t.y_rug&&a(t),this}function _(t){var e=Rr(t.target);Yr(e,".mg-y-axis");var r=zr(e,"mg-y-axis"),n=r.selectAll("text").data(t.categorical_variables).enter().append("svg:text").attr("x",t.left).attr("y",function(e){return t.scales.Y(e)+t.scales.Y.rangeBand()/2+t.buffer*t.outer_padding_percentage}).attr("dy",".35em").attr("text-anchor","end").text(String);Pr(n,t.rotate_y_labels)}function g(t){return $r(t,"Y",t.categorical_variables,wr(t),t.top,t.padding_percentage,t.outer_padding_percentage),Fr(t,"yf","Y",t.y_accessor),t.y_axis?(_(t),this):this}function v(t){"use strict";t.rug_buffer_size="point"===t.chart_type?t.buffer/2:t.buffer;var e=Er(t,"mg-x-rug");e.attr("x1",t.scalefns.xf).attr("x2",t.scalefns.xf).attr("y1",t.height-t.bottom-t.rug_buffer_size).attr("y2",t.height-t.bottom),Xr(e,t,"mg-x-rug-mono")}function x(t){t.processed||(t.processed={})}function y(e){Fr(e,"xf","X",e.x_accessor),se(e);var r=e.utc_time?t.time.scale.utc():t.time.scale();e.scales.X=e.time_series?r:t.scale.linear(),e.scales.X.domain([e.processed.min_x,e.processed.max_x]).range([Gr(e),Tr(e)-e.additional_buffer])}function b(t){"use strict";var e=Rr(t.target);if(x(t),y(t),"point"===t.chart_type&&(M(t),D(t)),Yr(e,".mg-x-axis"),!t.x_axis)return this;var r=zr(e,"mg-x-axis");return t.x_label&&Y(r,t),R(r,t),H(r,t),t.x_rug&&v(t),this}function w(t){var e=Rr(t.target),r=0;"bar"===t.chart_type&&(r=t.buffer+5),$r(t,"X",t.categorical_variables.reverse(),t.left,Tr(t)-r),Fr(t,"xf","X",t.x_accessor),Yr(e,".mg-x-axis");var n=zr(e,"mg-x-axis");return t.x_axis?(k(n,t,r),this):this}function k(t,e,r){var n=t.selectAll("text").data(e.categorical_variables).enter().append("svg:text");n.attr("x",function(t){return e.scales.X(t)+e.scales.X.rangeBand()/2+e.buffer*e.outer_padding_percentage+r/2}).attr("y",wr(e)).attr("dy",".35em").attr("text-anchor","middle").text(String),e.truncate_x_labels&&n.each(function(t){var r=this,n=e.scales.X.rangeBand();tn(r,t,n)}),Pr(n,e.rotate_x_labels)}function M(e){var r,n;null!==e.color_accessor&&(r=A(e),n=G(e),"number"===e.color_type?e.scales.color=t.scale.linear().domain(r).range(n).clamp(!0):(e.scales.color=null!==e.color_range?t.scale.ordinal().range(n):r.length>10?t.scale.category20():t.scale.category10(),e.scales.color.domain(r)),Fr(e,"color","color",e.color_accessor))}function A(e){var r;return null===e.color_domain?"number"===e.color_type?r=t.extent(e.data[0],function(t){return t[e.color_accessor]}):"category"===e.color_type&&(r=t.set(e.data[0].map(function(t){return t[e.color_accessor]})).values(),r.sort()):r=e.color_domain,r}function G(t){var e;return e=null===t.color_range?"number"===t.color_type?["blue","red"]:null:t.color_range}function D(e){var r,n;null!==e.size_accessor&&(r=T(e),n=O(e),e.scales.size=t.scale.linear().domain(r).range(n).clamp(!0),Fr(e,"size","size",e.size_accessor))}function T(e){return null===e.size_domain?t.extent(e.data[0],function(t){return t[e.size_accessor]}):e.size_domain}function O(t){var e;return e=null===t.size_range?[1,5]:t.size_range}function Y(t,e){t.append("text").attr("class","label").attr("x",function(){return(e.left+e.width-e.right)/2}).attr("y",(e.height-e.bottom/2).toFixed(2)).attr("dy",".50em").attr("text-anchor","middle").text(function(){return e.x_label})}function z(e){return function(r){if(1>r)return e.xax_units+t.round(r,e.decimals);var n=t.formatPrefix(r);return e.xax_units+n.scale(r)+n.symbol}}function C(t){var e;return e=E(t)?"millis":F(t)?"seconds":X(t)?"less-than-a-day":$(t)?"four-days":P(t)?"many-days":S(t)?"many-months":j(t)?"years":"default"}function E(t){return 10>t}function F(t){return 60>t}function X(t){return 24>=t/3600}function $(t){return 96>=t/3600}function P(t){return 93>=t/86400}function S(t){return 730>t/86400}function j(t){return t/86400>=730}function N(t,e){var r;return r=E(e)?MG.time_format(t,"%M:%S.%L"):F(e)?MG.time_format(t,"%M:%S"):X(e)?MG.time_format(t,"%H:%M"):$(e)?MG.time_format(t,"%H:%M"):P(e)?MG.time_format(t,"%b %d"):S(e)?MG.time_format(t,"%b"):MG.time_format(t,"%Y")}function L(t){var e,r,n;t.time_series&&(e=(t.processed.max_x-t.processed.min_x)/1e3,n=C(e),r=N(t.utc_time,e)),t.processed.main_x_time_format=r,t.processed.x_time_frame=n}function I(e){if(e.xax_format)return e.xax_format;var r=e.processed.original_data||e.data,n=Br(r)[0][e.processed.original_x_accessor||e.x_accessor];return function(r){L(e);var a=t.formatPrefix(r);return n instanceof Date?e.processed.main_x_time_format(new Date(r)):"number"==typeof n?1>r?e.xax_units+t.round(r,e.decimals):(a=t.formatPrefix(r),e.xax_units+a.scale(r)+a.symbol):r}}function R(t,e){"bar"===e.chart_type||e.y_extended_ticks||(B(e,t),q(e,t))}function B(t,e){var r=t.scales.X.ticks(t.xax_count).length-1;t.x_extended_ticks||e.append("line").attr("x1",function(){return 0===t.xax_count?Gr(t):t.axes_not_compact&&"bar"!==t.chart_type?t.left:t.scales.X(t.scales.X.ticks(t.xax_count)[0]).toFixed(2)}).attr("x2",function(){return 0===t.xax_count||t.axes_not_compact&&"bar"!==t.chart_type?Tr(t):t.scales.X(t.scales.X.ticks(t.xax_count)[r]).toFixed(2)}).attr("y1",t.height-t.bottom).attr("y2",t.height-t.bottom)}function q(t,e){var r=t.scales.X.ticks(t.xax_count);e.selectAll(".mg-xax-ticks").data(r).enter().append("line").attr("x1",function(e){return t.scales.X(e).toFixed(2)}).attr("x2",function(e){return t.scales.X(e).toFixed(2)}).attr("y1",t.height-t.bottom).attr("y2",function(){return t.x_extended_ticks?t.top:t.height-t.bottom+t.xax_tick_length}).attr("class",function(){return t.x_extended_ticks?"mg-extended-x-ticks":void 0}).classed("mg-xax-ticks",!0)}function H(t,e){U(e,t),Q(e,t)}function U(e,r){var n=e.scales.X.ticks(e.xax_count),a=r.selectAll(".mg-xax-labels").data(n).enter().append("text").attr("x",function(t){return e.scales.X(t).toFixed(2)}).attr("y",(e.height-e.bottom+7*e.xax_tick_length/3).toFixed(2)).attr("dy",".50em").attr("text-anchor","middle");if(e.time_series&&e.european_clock?(a.append("tspan").classed("mg-european-hours",!0).text(function(e,r){var n=new Date(e);return 0===r?t.time.format("%H")(n):""}),a.append("tspan").classed("mg-european-minutes-seconds",!0).text(function(t){var r=new Date(t);return":"+e.processed.xax_format(r)})):a.text(function(t){return e.xax_units+e.processed.xax_format(t)}),Sr(a)){a.filter(function(t,e){return(e+1)%2===0}).remove();var o=Rr(e.target);o.selectAll(".mg-xax-ticks").filter(function(t,e){return(e+1)%2===0}).remove()}}function Q(t,e){if(t.time_series&&(t.show_years||t.show_secondary_x_label)){var r=Z(t);V(t,e,r.timeframe,r.yformat,r.secondary)}}function Z(e){var r={};switch(r.timeframe=e.processed.x_time_frame,r.timeframe){case"millis":case"seconds":r.secondary=t.time.days,r.yformat=e.european_clock?MG.time_format(e.utc_time,"%b %d"):MG.time_format(e.utc_time,"%I %p");break;case"less-than-a-day":r.secondary=t.time.days,r.yformat=MG.time_format(e.utc_time,"%b %d");break;case"four-days":r.secondary=t.time.days,r.yformat=MG.time_format(e.utc_time,"%b %d");break;case"many-days":r.secondary=t.time.years,r.yformat=MG.time_format(e.utc_time,"%Y");break;case"many-months":r.secondary=t.time.years,r.yformat=MG.time_format(e.utc_time,"%Y");break;default:r.secondary=t.time.years,r.yformat=MG.time_format(e.utc_time,"%Y")}return r}function V(t,e,r,n,a){var o=a(t.processed.min_x,t.processed.max_x);if(0===o.length){var i=t.scales.X.ticks(t.xax_count)[0];o=[i]}var s=zr(e,"mg-year-marker");"default"===r&&t.show_year_markers&&W(t,s,o,n),"years"!=r&&J(t,s,o,n)}function W(t,e,r){e.selectAll(".mg-year-marker").data(r).enter().append("line").attr("x1",function(e){return t.scales.X(e).toFixed(2)}).attr("x2",function(e){return t.scales.X(e).toFixed(2)}).attr("y1",kr(t)).attr("y2",br(t))}function J(e,r,n,a){r.selectAll(".mg-year-marker").data(n).enter().append("text").attr("x",function(t){return e.scales.X(t).toFixed(2)}).attr("y",function(){var r=t.select(e.target).select(".mg-x-axis text").node().getBoundingClientRect();return br(e)+7*e.xax_tick_length/3+.8*r.height}).attr("dy",".50em").attr("text-anchor","middle").text(function(t){return a(new Date(t))})}function K(e,r,n){var a=t.extent(n,function(t){return t[r.x_accessor]});e.min=a[0],e.max=a[1]}function te(e,r,n){e.min=0,e.max=t.max(n,function(t){var e=[t[r.x_accessor],t[r.baseline_accessor]?t[r.baseline_accessor]:0,t[r.predictor_accessor]?t[r.predictor_accessor]:0];return Math.max.apply(null,e)})}function ee(t){var e=MG.clone(t.min).setDate(t.min.getDate()-1),r=MG.clone(t.min).setDate(t.min.getDate()+1);t.min=e,t.max=r}function re(t){t.min=t.min-1,t.max=t.max+1}function ne(t){t.min=Number(t.min)-1,t.max=Number(t.max)+1}function ae(t){t.xax_count=2}function oe(t,e,r){"line"===e.chart_type||"point"===e.chart_type||"histogram"===e.chart_type?K(t,e,r):"bar"===e.chart_type&&te(t,e,r),t.min!==t.max||e.min_x&&e.max_x||(t.min instanceof Date?ee(t):"number"==typeof min_x?re(t):"string"==typeof min_x&&ne(t),ae(e))}function ie(t){var e=Br(t.data),r={};oe(r,t,e),r.min=t.min_x||r.min,r.max=t.max_x||r.max,t.x_axis_negative=!1,t.processed.min_x=r.min,t.processed.max_x=r.max}function se(t){ie(t),le(t),MG.call_hook("x_axis.process_min_max",t,t.processed.min_x,t.processed.max_x),t.time_series||t.processed.min_x<0&&(t.processed.min_x=t.processed.min_x-t.processed.max_x*(t.inflator-1),t.x_axis_negative=!0),t.additional_buffer="bar"===t.chart_type?5*t.buffer:0}function le(t){var e=t.chart_type;t.processed.xax_format||(t.xax_format?t.processed.xax_format=t.xax_format:"line"===e||"point"===e||"histogram"===e?t.processed.xax_format=I(t):"bar"===e&&(t.processed.xax_format=z(t)))}function ce(t){var e={target:null,title:null,description:null};return t||(t={}),t.processed||(t.processed={}),t=Wr(t,e)}function ue(t){var e=Br(t.processed.original_data||t.data)[0];t.time_series=e[t.processed.original_x_accessor||t.x_accessor]instanceof Date}function fe(t){var e=t.width;t.full_width&&(e=Zr(t.target)),t.width=e}function de(t){var e=t.height;t.full_height&&(e=Vr(t.target)),"bar"===t.chart_type&&null===e&&(e=t.height=t.data[0].length*t.bar_height+t.top+t.bottom),t.height=e}function pe(t,e){(!t.selectAll(".mg-main-line").empty()&&"line"!==e.chart_type||!t.selectAll(".mg-points").empty()&&"point"!==e.chart_type||!t.selectAll(".mg-histogram").empty()&&"histogram"!==e.chart_type||!t.selectAll(".mg-barplot").empty()&&"bar"!==e.chart_type)&&t.remove()}function me(e,r){return Rr(r.target).empty()&&(e=t.select(r.target).append("svg").classed("linked",r.linked).attr("width",r.width).attr("height",r.height)),e}function he(t,e){t.selectAll(".mg-clip-path").remove(),t.append("defs").attr("class","mg-clip-path").append("clipPath").attr("id","mg-plot-window-"+Hr(e.target)).append("svg:rect").attr("x",e.left).attr("y",e.top).attr("width",e.width-e.left-e.right-e.buffer).attr("height",e.height-e.top-e.bottom-e.buffer+1)}function _e(t,e){e.width!==Number(t.attr("width"))&&t.attr("width",e.width),e.height!==Number(t.attr("height"))&&t.attr("height",e.height)}function ge(t,e){t.attr("viewBox","0 0 "+e.width+" "+e.height),(e.full_width||e.full_height)&&t.attr("preserveAspectRatio","xMinYMin meet")}function ve(t){t.classed("mg-missing",!1),t.selectAll(".mg-missing-text").remove(),t.selectAll(".mg-missing-pane").remove()}function xe(t,e){var r=0;if(t.selectAll(".mg-main-line")[0].length>=e.data.length)if(e.custom_line_color_map.length>0){var n=function(t){for(var e=new Array(t),r=0;r<e.length;r++)e[r]=r+1;return e},a=Jr(n(e.max_data_size),e.custom_line_color_map);for(r=0;r<a.length;r++)t.selectAll(".mg-main-line.mg-line"+a[r]+"-color").remove()}else{var o=e.data.length,i=t.selectAll(".mg-main-line")[0].length;for(r=i;r>o;r--)t.selectAll(".mg-main-line.mg-line"+r+"-color").remove()}}function ye(t,e){return t.empty()?void console.warn('The specified target element "'+e.target+'" could not be found in the page. The chart will not be rendered.'):void 0}function be(e){"use strict";e=arguments[0],e=ce(e);var r=t.select(e.target);ye(r,e);var a=r.selectAll("svg");return ue(e),fe(e),de(e),pe(a,e),a=me(a,e),he(a,e),_e(a,e),ge(a,e),ve(a),n(e),xe(a,e),this}function we(t){return t.label}function ke(t){t.selectAll(".mg-markers").remove(),t.selectAll(".mg-baselines").remove()}function Me(t){return function(e){return t.scales.X(e[t.x_accessor])>Gr(t)&&t.scales.X(e[t.x_accessor])<Tr(t)}}function Ae(t){return function(e){return t.scales.X(e[t.x_accessor])}}function Ge(t){var e=Ae(t);return function(t){return e(t).toFixed(2)}}function De(t){var e=t.scales.Y;return function(t){return e(t.value).toFixed(2)}}function Te(t,e,r,n,a,o){var i;t&&(i=n.append("g").attr("class",e),a(i,r),o(i,r))}function Oe(t,e){Te(t.markers,"mg-markers",t,e,ze,Ce)}function Ye(t,e){Te(t.baselines,"mg-baselines",t,e,Ee,Fe)}function ze(t,e){var r=Ge(e);t.selectAll(".mg-markers").data(e.markers.filter(Me(e))).enter().append("line").attr("x1",r).attr("x2",r).attr("y1",e.top).attr("y2",wr(e)).attr("class",function(t){return t.lineclass}).attr("stroke-dasharray","3,1")}function Ce(e,r){e.selectAll(".mg-markers").data(r.markers.filter(Me(r))).enter().append("text").attr("class",function(t){return t.textclass||""}).classed("mg-marker-text",!0).attr("x",Ae(r)).attr("y",.95*r.top).attr("text-anchor","middle").text(we).each(function(e){e.click&&t.select(this).style("cursor","pointer").on("click",e.click)}),jr(e.selectAll(".mg-marker-text")[0],r)}function Ee(t,e){var r=De(e);t.selectAll(".mg-baselines").data(e.baselines).enter().append("line").attr("x1",Gr(e)).attr("x2",Tr(e)).attr("y1",r).attr("y2",r)}function Fe(t,e){var r=De(e);t.selectAll(".mg-baselines").data(e.baselines).enter().append("text").attr("x",Tr(e)).attr("y",r).attr("dy",-3).attr("text-anchor","end").text(we)}function Xe(t){"use strict";var e=Rr(t.target);return ke(e),Oe(t,e),Ye(t,e),this}function $e(t,e){var r="",n=null;return 3===arguments.length&&(n=arguments[2]),r=t.append("tspan").text(e),null!==n&&r.classed(n,!0),function(){return this.tspan=r,this.bold=function(){return this.tspan.attr("font-weight","bold"),this},this.color=function(t,e){"line"===t.chart_type?this.tspan.classed("mg-hover-line"+e.line_id+"-color",null===t.colors).attr("stroke",null===t.colors?"":t.colors[e.line_id-1]):"point"===t.chart_type&&(null!==t.color_accessor?(this.tspan.attr("fill",t.scalefns.color(e)),this.tspan.attr("stroke",t.scalefns.color(e))):this.tspan.classed("mg-points-mono",!0))},this.x=function(t){return this.tspan.attr("x",t),this},this.y=function(t){return this.tspan.attr("y",t),this},this.elem=function(){return this.tspan},this}()}function Pe(t){var e=t.select(".mg-active-datapoint");return e.selectAll("*").remove(),e}function Se(t,e,r,n,a,o,i,s){var l=0,c=1.1;t.time_series?je(t,r,n,s,o):Ne(t,r,n,s,o),$e(r," ").x(0).y(l*c+"em")}function je(t,e,r,n,a){var o,i=0,s=1.1;$e(e,r.trim()),i=1;var l;n.values.forEach(function(r){l=e.append("tspan").attr("x",0).attr("y",i*s+"em"),o=cr(t,a,r),$e(l,"‚Äî  ").color(t,r),$e(l,o),i++}),$e(e," ").x(0).y(i*s+"em")}function Ne(t,e,r,n,a){var o=0,i=1.1;n.values.forEach(function(n){formatted_y=cr(t,a,n),formatted_y=null!==t.y_rollover_format?on(t.y_rollover_format,n,t.y_accessor):t.yax_units+a(n[t.y_accessor]),sub_container=e.append("tspan").attr("x",0).attr("y",o*i+"em"),formatted_y=cr(t,a,n),$e(sub_container,"‚Äî  ").color(t,n),$e(sub_container,r+" "+formatted_y),o++})}function Le(t,e,r,n,a,o){var i=lr(t),s=Pe(e),l=cr(t,i,a),c=ur(t,r,a);t.aggregate_rollover&&t.data.length>1?Se(t,e,s,c,l,i,r,a,o):(t.time_series&&s.select("*").remove(),(t.legend||t.label_accessor)&&$e(s,"line"===t.chart_type?t.legend[a.line_id-1]+"  ":a[t.label_accessor]+"  ").color(t,a),(t.data.length>1||"point"===t.chart_type)&&$e(s,n+"  ").color(t,a),$e(s,c,t.time_series?"mg-x-rollover-text":null),$e(s,l,t.time_series?"mg-y-rollover-text":null))}function Ie(t){Re(t)}function Re(e){function r(){var r=t.select(e.target).select("svg"),n=0!==r.attr("width")?r.attr("height")/r.attr("width"):0,a=Zr(e.target);r.attr("width",a),r.attr("height",n*a)}(e.full_width||e.full_height)&&null===window.onresize&&(window.onresize=r)}function Be(t){"use strict";if(t.data=MG.clone(t.data),t.array_of_objects=!1,t.array_of_arrays=!1,t.nested_array_of_arrays=!1,t.nested_array_of_objects=!1,vr(t.data)?(t.nested_array_of_objects=t.data.map(function(t){return yr(t)}),t.nested_array_of_arrays=t.data.map(function(t){return vr(t)})):(t.array_of_objects=xr(t.data),t.array_of_arrays=vr(t.data)),"line"===t.chart_type?(t.array_of_objects||t.array_of_arrays)&&(t.data=[t.data]):t.data[0]instanceof Array||(t.data=[t.data]),qe(t),void 0!==t.color&&(t.colors=t.color),null!==t.colors&&"string"==typeof t.colors&&(t.colors=[t.colors]),"line"===t.chart_type&&t.x_sort===!0)for(var e=0;e<t.data.length;e++)t.data[e].sort(function(e,r){return e[t.x_accessor]-r[t.x_accessor]});return this}function qe(t){t.y_accessor instanceof Array&&(t.data=t.data.map(function(e){return t.y_accessor.map(function(t){return e.map(function(e){return e=MG.clone(e),void 0===e[t]?void 0:(e.multiline_y_accessor=e[t],e)}).filter(function(t){return void 0!==t})})})[0],t.y_accessor="multiline_y_accessor")}function He(e){"use strict";var r,n=t.sum(e.data.map(function(t){return t.length>0&&t[0][e.x_accessor]instanceof Date}))>0;if(e.missing_is_hidden&&(e.interpolate="linear"),(e.missing_is_zero||e.missing_is_hidden)&&"line"===e.chart_type&&n)for(var a=0;a<e.data.length;a++)if(!(e.data[a].length<=1)){var o=e.data[a][0],i=e.data[a][e.data[a].length-1],s=[],l=MG.clone(o[e.x_accessor]).setDate(o[e.x_accessor].getDate()+1),c=e.min_x?e.min_x:l,u=e.max_x?e.max_x:i[e.x_accessor];if(r=C((u-c)/1e3),"default"==r&&null===e.missing_is_hidden_accessor)for(var f=new Date(c);u>=f;f.setDate(f.getDate()+1)){var d={};f.setHours(0,0,0,0),Date.parse(f)===Date.parse(new Date(l))&&s.push(MG.clone(e.data[a][0]));var p=null;e.data[a].forEach(function(t){return Date.parse(t[e.x_accessor])===Date.parse(new Date(f))?(p=t,!1):void 0}),p?p[e.missing_is_hidden_accessor]||null===p[e.y_accessor]?(p._missing=!0,s.push(p)):s.push(p):(d[e.x_accessor]=new Date(f),d[e.y_accessor]=0,d._missing=!0,s.push(d))}else for(var m=0;m<e.data[a].length;m+=1){var h=MG.clone(e.data[a][m]);h._missing=e.data[a][m][e.missing_is_hidden_accessor],s.push(h)}e.data[a]=s}return this}function Ue(e){"use strict";var r,n=e.data[0];if(e.binned===!1){if("object"==typeof n[0])r=n.map(function(t){return t[e.x_accessor]});else{if("number"!=typeof n[0])return void console.log("TypeError: expected an array of numbers, found "+typeof n[0]);r=n}var a=t.layout.histogram();e.bins&&(a=a.bins(e.bins)),e.processed_data=a(r).map(function(t){return{x:t.x,y:t.y,dx:t.dx}})}else{e.processed_data=n.map(function(t){return{x:t[e.x_accessor],y:t[e.y_accessor]}});for(var o,i,s=0;s<e.processed_data.length;s++)o=e.processed_data[s],s===e.processed_data.length-1?o.dx=e.processed_data[s-1].dx:(i=e.processed_data[s+1],o.dx=i.x-o.x)}return e.processed||(e.processed={}),e.processed.original_data=e.data,e.processed.original_x_accessor=e.x_accessor,e.processed.original_y_accessor=e.y_accessor,e.data=[e.processed_data],e.x_accessor=e.processed_x_accessor,e.y_accessor=e.processed_y_accessor,this}function Qe(e){"use strict";var r,n={},a=e.data[0],o="vertical"===e.bar_orientation?e.x_accessor:e.y_accessor,i="vertical"===e.bar_orientation?e.y_accessor:e.x_accessor;if(e.categorical_variables=[],e.binned===!1){r="object"==typeof a[0]?a.map(function(t){return t[o]}):a;for(var s,l=0;l<r.length;l++)s=r[l],-1===e.categorical_variables.indexOf(s)&&e.categorical_variables.push(s),n.hasOwnProperty(s)||(n[s]=0),n[s]+=1;n=Object.keys(n).map(function(t){var e={};return e[i]=n[t],e[o]=t,e})}else n=a,e.categorical_variables=t.set(n.map(function(t){return t[o]})).values(),e.categorical_variables.reverse();return e.data=[n],this}function Ze(t){"use strict";var e=t.data[0],r=e.map(function(e){return e[t.x_accessor]}),n=e.map(function(e){return e[t.y_accessor]});return t.least_squares&&(t.ls_line=tr(r,n)),this}function Ve(e){var r=Rr(e.target),n=e.data[0],a=t.min(n,function(t){return t[e.x_accessor]}),o=t.max(n,function(t){return t[e.x_accessor]});t.select(e.target).selectAll(".mg-least-squares-line").remove(),r.append("svg:line").attr("x1",e.scales.X(a)).attr("x2",e.scales.X(o)).attr("y1",e.scales.Y(e.ls_line.fit(a))).attr("y2",e.scales.Y(e.ls_line.fit(o))).attr("class","mg-least-squares-line")}function We(r){var n=t.select(e(r.target).find("svg").get(0)),a=r.lowess_line,o=t.svg.line().x(function(t){return r.scales.X(t.x)}).y(function(t){return r.scales.Y(t.y)}).interpolate(r.interpolate);n.append("path").attr("d",o(a)).attr("class","mg-lowess-line")}function Je(e,r,n,a){{var o,i,s=[];t.mean(r)}for(i=0;i<e.length;i+=1)s.push(1);o=sr(e,r,n,a,s);var l=o.x,c=o.y;for(i=0;100>i;i+=1){s=t.zip(c,r).map(function(t){return Math.abs(t[1]-t[0])});var u=t.quantile(s.sort(),.5);s=s.map(function(t){return rr(t/(6*u))}),o=sr(e,r,n,a,s),l=o.x,c=o.y}return t.zip(l,c).map(function(t){var e={};return e.x=t[0],e.y=t[1],e})}function Ke(t,e,r,n){for(var a=[],o=0;o<t.length;o+=1)a.push(1);sr(t,e,r,n,a)}function tr(e,r){{var n,a,o,i;e.length}n=e[0]instanceof Date?e.map(function(t){return t.getTime()}):e,a=r[0]instanceof Date?r.map(function(t){return t.getTime()}):r;for(var s=t.mean(n),l=t.mean(a),c=0,u=0,f=0;f<n.length;f++)o=n[f],i=a[f],c+=(o-s)*(i-l),u+=(o-s)*(o-s);var d=c/u,p=l-d*s;return{x0:p,beta:d,fit:function(t){return p+t*d}}}function er(t,e){return t>=0&&1>=t?Math.pow(1-Math.pow(t,e),e):0}function rr(t){return er(t,2)}function nr(t){return er(t,3)}function ar(e){var r=t.sum(e.map(function(t){return t.w}));return{xbar:t.sum(e.map(function(t){return t.w*t.x}))/r,ybar:t.sum(e.map(function(t){return t.w*t.y}))/r}}function or(e,r,n){var a=t.sum(e.map(function(t){return Math.pow(t.w,2)*(t.x-r)*(t.y-n)})),o=t.sum(e.map(function(t){return Math.pow(t.w,2)*Math.pow(t.x-r,2)}));return a/o}function ir(t){var e,r,n=ar(t);r=n.xbar,e=n.ybar;var a=or(t,r,e);return{beta:a,xbar:r,ybar:e,x0:e-a*r}}function sr(e,r,n,a,o){var i=Math.floor(e.length*n),s=e.slice();s.sort(function(t,e){return e>t?-1:t>e?1:0});for(var l,c,u,f,d,p=t.quantile(s,.98),m=t.quantile(s,.02),h=t.zip(e,r,o).sort(),_=Math.abs(p-m)/a,g=m,v=p,x=t.range(g,v,_),y=[],b=0;b<x.length;b+=1){c=x[b],l=h.map(function(t){return[Math.abs(t[0]-c),t[0],t[1],t[2]]}).sort().slice(0,i),d=t.max(l)[0],l=l.map(function(t){return{w:nr(t[0]/d)*t[3],x:t[1],y:t[2]}});var w=ir(l);f=w.x0,u=w.beta,y.push(f+u*c)}return{x:x,y:y}}function lr(e){var r;return r="count"===e.format?function(r){var n=r%1!==0,a=t.format("0,000");return r=n?t.round(r,e.decimals):r,a(r)}:function(r){var n=(e.decimals?"."+e.decimals:"")+"%",a=t.format(n);return a(r)}}function cr(t,e,r){var n;return n=null!==t.y_mouseover?t.aggregate_rollover?on(t.y_mouseover,r,t.y_accessor):on(t.y_mouseover,r,t.y_accessor):t.time_series?t.aggregate_rollover?e(r[t.y_accessor]):t.yax_units+e(r[t.y_accessor]):t.y_accessor+": "+t.yax_units+e(r[t.y_accessor])}function ur(t,e,r){var n;if(null!==t.x_mouseover)n=t.time_series?t.aggregate_rollover?an(t.x_mouseover,r,"key",t.utc):an(t.x_mouseover,r,t.x_accessor,t.utc):on(t.x_mouseover,r,t.x_accessor);else if(t.time_series){var a;t.aggregate_rollover&&t.data.length>1?a=new Date(r.key):(a=new Date(+r[t.x_accessor]),a.setDate(a.getDate())),n=e(a)+"  "}else n=t.x_accessor+": "+r[t.x_accessor]+", ";return n}function fr(e,r){return function(){for(var n=this,a=n.cloneNode(),o=n.getTotalLength()||0,i=(a.setAttribute("d",e),a).getTotalLength()||0,s=[0],l=0,c=r/Math.max(o,i);(l+=c)<1;)s.push(l);s.push(1);var u=s.map(function(e){var r=n.getPointAtLength(e*o),s=a.getPointAtLength(e*i);return t.interpolate([r.x,r.y],[s.x,s.y])});return function(t){return 1>t?"M"+u.map(function(e){return e(t)}).join("L"):e}}}function dr(t){var e;switch(t.processed.x_time_frame){case"millis":e=MG.time_format(t.utc_time,"%b %e, %Y  %H:%M:%S.%L");break;case"seconds":e=MG.time_format(t.utc_time,"%b %e, %Y  %H:%M:%S");break;case"less-than-a-day":e=MG.time_format(t.utc_time,"%b %e, %Y  %I:%M%p");break;case"four-days":e=MG.time_format(t.utc_time,"%b %e, %Y  %I:%M%p");break;default:e=MG.time_format(t.utc_time,"%b %e, %Y")}return e}function pr(t,e){return t[e.x_accessor]>=e.processed.min_x&&t[e.x_accessor]<=e.processed.max_x&&t[e.y_accessor]>=e.processed.min_y&&t[e.y_accessor]<=e.processed.max_y}function mr(t){return"[object Array]"===Object.prototype.toString.call(t)}function hr(t){return"[object Function]"===Object.prototype.toString.call(t)}function _r(t){return mr(t)&&0===t.length}function gr(t){return"[object Object]"===Object.prototype.toString.call(t)}function vr(e){var r=e.map(function(t){return mr(t)===!0&&t.length>0});return t.sum(r)===e.length}function xr(e){var r=e.map(function(t){return gr(t)===!0});return t.sum(r)===e.length}function yr(t){return _r(t)||xr(t)}function br(t){return t.height-t.bottom}function wr(t){return br(t)-t.buffer}function kr(t){return t.top}function Mr(t){return kr(t)+t.buffer}function Ar(t){return t.left}function Gr(t){return Ar(t)+t.buffer}function Dr(t){return t.width-t.right}function Tr(t){return Dr(t)-t.buffer}function Or(t){t.exit().remove()}function Yr(t,e){t.selectAll(e).remove()}function zr(t,e){return t.append("g").classed(e,!0)}function Cr(t,e){t.select(e).remove()}function Er(t,e){var r=Rr(t.target),n=Br(t.data),a=r.selectAll("line."+e).data(n);return a.enter().append("svg:line").attr("class",e).attr("opacity",.3),Or(a),Or(a),a}function Fr(t,e,r,n){t.scalefns[e]=function(e){return t.scales[r](e[n])}}function Xr(t,e,r){e.color_accessor?(t.attr("stroke",e.scalefns.color),t.classed(r,!1)):(t.attr("stroke",null),t.classed(r,!0))}function $r(e,r,n,a,o,i,s){e.scales[r]=t.scale.ordinal().domain(n).rangeRoundBands([a,o],i||0,s||0)}function Pr(e,r){r&&e.attr({dy:0,transform:function(){var e=t.select(this);return"rotate("+r+" "+e.attr("x")+","+e.attr("y")+")"}})}function Sr(t){t=t[0];for(var e=0;e<t.length;e++)if(Ir(t[e],t))return!0;return!1}function jr(e,r){if(e&&1!=e.length)for(var n=0;n<e.length;n++)if(Ir(e[n],e)){var a=t.select(e[n]),o=+a.attr("y");o+8>=r.top&&(o=r.top-16),a.attr("y",o)}}function Nr(e){if(e&&1!=e.length){e.sort(function(e,r){return t.select(r).attr("y")-t.select(e).attr("y")}),e.reverse();for(var r,n,a,o=0;o<e.length;o++){n=t.select(e[o]).text();for(var i=0;i<e.length;i++)if(a=t.select(e[i]).text(),r=Lr(e[o],e[i]),r!==!1&&n!==a){var s=t.select(e[o]),l=+s.attr("y");l+=r,s.attr("y",l)}}}}function Lr(t,e){var r=t.getBoundingClientRect(),n=e.getBoundingClientRect();return r.top<=n.bottom&&r.top>=n.top?n.bottom-r.top:!1}function Ir(t,e){for(var r=t.getBoundingClientRect(),n=0;n<e.length;n++)if(e[n]!=t){var a=e[n].getBoundingClientRect();if(r.top===a.top&&!(a.left>r.right||a.right<r.left))return!0}return!1}function Rr(e){return t.select(e).select("svg")}function Br(t){var e=[];return e.concat.apply(e,t)}function qr(){return"undefined"==typeof MG._next_elem_id&&(MG._next_elem_id=0),"mg-"+MG._next_elem_id++}function Hr(t){return"string"==typeof t?Ur(t):t instanceof HTMLElement?(target_ref=t.getAttribute("data-mg-uid"),target_ref||(target_ref=qr(),t.setAttribute("data-mg-uid",target_ref)),target_ref):(console.warn("The specified target should be a string or an HTMLElement.",t),Ur(t))
}function Ur(t){return t.replace(/[^a-zA-Z0-9 _-]+/g,"").replace(/ +?/g,"")}function Qr(e,r){return Number(t.select(e).style(r).replace(/px/g,""))}function Zr(t){return Qr(t,"width")}function Vr(t){return Qr(t,"height")}function Wr(t){return sn(Array.prototype.slice.call(arguments,1),function(e){if(e)for(var r in e)void 0===t[r]&&(t[r]=e[r])}),t}function Jr(t,e){var r,n=[],a=[];for(r=0;r<e.length;r++)n[e[r]]=!0;for(r=0;r<t.length;r++)n[t[r]]||a.push(t[r]);return a}function Kr(t,e){console.warn("Deprecation: "+t+(e?". This feature will be removed in "+e+".":" the near future.")),console.trace()}function tn(t,e,r){var n,a=0;for(t.textContent=e,n=t.getBBox();n.width>r&&(t.textContent=e.slice(0,--a)+"...",n=t.getBBox(),"..."!==t.textContent););}function en(e,r,n,a){e.each(function(){for(var e,o=t.select(this),i=o.text().split(n||/\s+/).reverse(),s=[],l=0,c=1.1,u=(o.attr("y"),0),f=o.text(null).append("tspan").attr("x",0).attr("y",u+"em").attr(a||{});e=i.pop();)s.push(e),f.text(s.join(" ")),(null===r||f.node().getComputedTextLength()>r)&&(s.pop(),f.text(s.join(" ")),s=[e],f=o.append("tspan").attr("x",0).attr("y",++l*c+u+"em").attr(a||{}).text(e))})}function rn(e){console.log("ERROR : ",e.target," : ",e.error),t.select(e.target).select(".mg-chart-title").append("i").attr("class","fa fa-x fa-exclamation-circle warning")}function nn(t){console.log("INTERNAL ERROR : ",t.target," : ",t.internal_error)}window.MG={version:"2.7.0"},MG.register=r,MG._hooks={},MG.add_hook=function(t,e,r){var n;MG._hooks[t]||(MG._hooks[t]=[]),n=MG._hooks[t];var a=n.filter(function(t){return t.func===e}).length>0;if(a)throw"That function is already registered.";n.push({func:e,context:r})},MG.call_hook=function(t){var e,r=MG._hooks[t],n=[].slice.apply(arguments,[1]);return r&&r.forEach(function(t){if(t.func){var r=e||n;r&&r.constructor!==Array&&(r=[r]),r=[].concat.apply([],r),e=t.func.apply(t.context,r)}}),e||n},MG.globals={},MG.deprecations={rollover_callback:{replacement:"mouseover",version:"2.0"},rollout_callback:{replacement:"mouseout",version:"2.0"},x_rollover_format:{replacement:"x_mouseover",version:"2.10"},y_rollover_format:{replacement:"y_mouseover",version:"2.10"},show_years:{replacement:"show_secondary_x_label",version:"2.1"},xax_start_at_min:{replacement:"axes_not_compact",version:"2.7"}},MG.globals.link=!1,MG.globals.version="1.1",MG.charts={},MG.data_graphic=function(t){"use strict";var e={missing_is_zero:!1,missing_is_hidden:!1,missing_is_hidden_accessor:null,legend:"",legend_target:"",error:"",animate_on_load:!1,top:65,title_y_position:10,bottom:30,right:10,left:50,buffer:8,width:350,height:220,full_width:!1,full_height:!1,small_height_threshold:120,small_width_threshold:160,xax_count:6,xax_tick_length:5,axes_not_compact:!0,yax_count:5,yax_tick_length:5,x_extended_ticks:!1,y_extended_ticks:!1,y_scale_type:"linear",max_x:null,max_y:null,min_x:null,min_y:null,min_y_from_data:!1,point_size:2.5,x_accessor:"date",xax_units:"",x_label:"",x_sort:!0,x_axis:!0,y_axis:!0,y_accessor:"value",y_label:"",yax_units:"",x_rug:!1,y_rug:!1,x_mouseover:null,y_mouseover:null,transition_on_update:!0,mouseover:null,click:null,show_rollover_text:!0,show_confidence_band:null,xax_format:null,area:!0,chart_type:"line",data:[],decimals:2,format:"count",inflator:10/9,linked:!1,linked_format:"%Y-%m-%d",list:!1,baselines:null,markers:null,scalefns:{},scales:{},utc_time:!1,european_clock:!1,show_year_markers:!1,show_secondary_x_label:!0,target:"#viz",interpolate:"cardinal",interpolate_tension:.7,custom_line_color_map:[],colors:null,max_data_size:null,aggregate_rollover:!1,show_tooltips:!0};MG.call_hook("global.defaults",e),t||(t={});var r=MG.charts[t.chart_type||e.chart_type];Wr(t,r.defaults,e),t.list&&(t.x_accessor=0,t.y_accessor=1);for(var n in MG.deprecations)if(t.hasOwnProperty(n)){var a=MG.deprecations[n],o="Use of `args."+n+"` has been deprecated",i=a.replacement;if(i&&(t[i]?o+=". The replacement - `args."+i+"` - has already been defined. This definition will be discarded.":t[i]=t[n]),a.warned)continue;a.warned=!0,i&&(o+=" in favor of `args."+i+"`"),Kr(o,a.version)}return MG.call_hook("global.before_init",t),new r.descriptor(t),t.data},"undefined"!=typeof jQuery&&(+function(t){"use strict";function e(e){return this.each(function(){var n=t(this),a=n.data("bs.tooltip"),o="object"==typeof e&&e;(a||!/destroy|hide/.test(e))&&(a||n.data("bs.tooltip",a=new r(this,o)),"string"==typeof e&&a[e]())})}var r=function(t,e){this.type=null,this.options=null,this.enabled=null,this.timeout=null,this.hoverState=null,this.$element=null,this.inState=null,this.init("tooltip",t,e)};r.VERSION="3.3.5",r.TRANSITION_DURATION=150,r.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1,viewport:{selector:"body",padding:0}},r.prototype.init=function(e,r,n){if(this.enabled=!0,this.type=e,this.$element=t(r),this.options=this.getOptions(n),this.$viewport=this.options.viewport&&t(t.isFunction(this.options.viewport)?this.options.viewport.call(this,this.$element):this.options.viewport.selector||this.options.viewport),this.inState={click:!1,hover:!1,focus:!1},this.$element[0]instanceof document.constructor&&!this.options.selector)throw new Error("`selector` option must be specified when initializing "+this.type+" on the window.document object!");for(var a=this.options.trigger.split(" "),o=a.length;o--;){var i=a[o];if("click"==i)this.$element.on("click."+this.type,this.options.selector,t.proxy(this.toggle,this));else if("manual"!=i){var s="hover"==i?"mouseenter":"focusin",l="hover"==i?"mouseleave":"focusout";this.$element.on(s+"."+this.type,this.options.selector,t.proxy(this.enter,this)),this.$element.on(l+"."+this.type,this.options.selector,t.proxy(this.leave,this))}}this.options.selector?this._options=t.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},r.prototype.getDefaults=function(){return r.DEFAULTS},r.prototype.getOptions=function(e){return e=t.extend({},this.getDefaults(),this.$element.data(),e),e.delay&&"number"==typeof e.delay&&(e.delay={show:e.delay,hide:e.delay}),e},r.prototype.getDelegateOptions=function(){var e={},r=this.getDefaults();return this._options&&t.each(this._options,function(t,n){r[t]!=n&&(e[t]=n)}),e},r.prototype.enter=function(e){var r=e instanceof this.constructor?e:t(e.currentTarget).data("bs."+this.type);return r||(r=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,r)),e instanceof t.Event&&(r.inState["focusin"==e.type?"focus":"hover"]=!0),r.tip().hasClass("in")||"in"==r.hoverState?void(r.hoverState="in"):(clearTimeout(r.timeout),r.hoverState="in",r.options.delay&&r.options.delay.show?void(r.timeout=setTimeout(function(){"in"==r.hoverState&&r.show()},r.options.delay.show)):r.show())},r.prototype.isInStateTrue=function(){for(var t in this.inState)if(this.inState[t])return!0;return!1},r.prototype.leave=function(e){var r=e instanceof this.constructor?e:t(e.currentTarget).data("bs."+this.type);return r||(r=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,r)),e instanceof t.Event&&(r.inState["focusout"==e.type?"focus":"hover"]=!1),r.isInStateTrue()?void 0:(clearTimeout(r.timeout),r.hoverState="out",r.options.delay&&r.options.delay.hide?void(r.timeout=setTimeout(function(){"out"==r.hoverState&&r.hide()},r.options.delay.hide)):r.hide())},r.prototype.show=function(){var e=t.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(e);var n=t.contains(this.$element[0].ownerDocument.documentElement,this.$element[0]);if(e.isDefaultPrevented()||!n)return;var a=this,o=this.tip(),i=this.getUID(this.type);this.setContent(),o.attr("id",i),this.$element.attr("aria-describedby",i),this.options.animation&&o.addClass("fade");var s="function"==typeof this.options.placement?this.options.placement.call(this,o[0],this.$element[0]):this.options.placement,l=/\s?auto?\s?/i,c=l.test(s);c&&(s=s.replace(l,"")||"top"),o.detach().css({top:0,left:0,display:"block"}).addClass(s).data("bs."+this.type,this),this.options.container?o.appendTo(this.options.container):o.insertAfter(this.$element),this.$element.trigger("inserted.bs."+this.type);var u=this.getPosition(),f=o[0].offsetWidth,d=o[0].offsetHeight;if(c){var p=s,m=this.getPosition(this.$viewport);s="bottom"==s&&u.bottom+d>m.bottom?"top":"top"==s&&u.top-d<m.top?"bottom":"right"==s&&u.right+f>m.width?"left":"left"==s&&u.left-f<m.left?"right":s,o.removeClass(p).addClass(s)}var h=this.getCalculatedOffset(s,u,f,d);this.applyPlacement(h,s);var _=function(){var t=a.hoverState;a.$element.trigger("shown.bs."+a.type),a.hoverState=null,"out"==t&&a.leave(a)};t.support.transition&&this.$tip.hasClass("fade")?o.one("bsTransitionEnd",_).emulateTransitionEnd(r.TRANSITION_DURATION):_()}},r.prototype.applyPlacement=function(e,r){var n=this.tip(),a=n[0].offsetWidth,o=n[0].offsetHeight,i=parseInt(n.css("margin-top"),10),s=parseInt(n.css("margin-left"),10);isNaN(i)&&(i=0),isNaN(s)&&(s=0),e.top+=i,e.left+=s,t.offset.setOffset(n[0],t.extend({using:function(t){n.css({top:Math.round(t.top),left:Math.round(t.left)})}},e),0),n.addClass("in");var l=n[0].offsetWidth,c=n[0].offsetHeight;"top"==r&&c!=o&&(e.top=e.top+o-c);var u=this.getViewportAdjustedDelta(r,e,l,c);u.left?e.left+=u.left:e.top+=u.top;var f=/top|bottom/.test(r),d=f?2*u.left-a+l:2*u.top-o+c,p=f?"offsetWidth":"offsetHeight";n.offset(e),this.replaceArrow(d,n[0][p],f)},r.prototype.replaceArrow=function(t,e,r){this.arrow().css(r?"left":"top",50*(1-t/e)+"%").css(r?"top":"left","")},r.prototype.setContent=function(){var t=this.tip(),e=this.getTitle();t.find(".tooltip-inner")[this.options.html?"html":"text"](e),t.removeClass("fade in top bottom left right")},r.prototype.hide=function(e){function n(){"in"!=a.hoverState&&o.detach(),a.$element.removeAttr("aria-describedby").trigger("hidden.bs."+a.type),e&&e()}var a=this,o=t(this.$tip),i=t.Event("hide.bs."+this.type);return this.$element.trigger(i),i.isDefaultPrevented()?void 0:(o.removeClass("in"),t.support.transition&&o.hasClass("fade")?o.one("bsTransitionEnd",n).emulateTransitionEnd(r.TRANSITION_DURATION):n(),this.hoverState=null,this)},r.prototype.fixTitle=function(){var t=this.$element;(t.attr("title")||"string"!=typeof t.attr("data-original-title"))&&t.attr("data-original-title",t.attr("title")||"").attr("title","")},r.prototype.hasContent=function(){return this.getTitle()},r.prototype.getPosition=function(e){e=e||this.$element;var r=e[0],n="BODY"==r.tagName,a=r.getBoundingClientRect();null==a.width&&(a=t.extend({},a,{width:a.right-a.left,height:a.bottom-a.top}));var o=n?{top:0,left:0}:e.offset(),i={scroll:n?document.documentElement.scrollTop||document.body.scrollTop:e.scrollTop()},s=n?{width:t(window).width(),height:t(window).height()}:null;return t.extend({},a,i,s,o)},r.prototype.getCalculatedOffset=function(t,e,r,n){return"bottom"==t?{top:e.top+e.height,left:e.left+e.width/2-r/2}:"top"==t?{top:e.top-n,left:e.left+e.width/2-r/2}:"left"==t?{top:e.top+e.height/2-n/2,left:e.left-r}:{top:e.top+e.height/2-n/2,left:e.left+e.width}},r.prototype.getViewportAdjustedDelta=function(t,e,r,n){var a={top:0,left:0};if(!this.$viewport)return a;var o=this.options.viewport&&this.options.viewport.padding||0,i=this.getPosition(this.$viewport);if(/right|left/.test(t)){var s=e.top-o-i.scroll,l=e.top+o-i.scroll+n;s<i.top?a.top=i.top-s:l>i.top+i.height&&(a.top=i.top+i.height-l)}else{var c=e.left-o,u=e.left+o+r;c<i.left?a.left=i.left-c:u>i.right&&(a.left=i.left+i.width-u)}return a},r.prototype.getTitle=function(){var t,e=this.$element,r=this.options;return t=e.attr("data-original-title")||("function"==typeof r.title?r.title.call(e[0]):r.title)},r.prototype.getUID=function(t){do t+=~~(1e6*Math.random());while(document.getElementById(t));return t},r.prototype.tip=function(){if(!this.$tip&&(this.$tip=t(this.options.template),1!=this.$tip.length))throw new Error(this.type+" `template` option must consist of exactly 1 top-level element!");return this.$tip},r.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},r.prototype.enable=function(){this.enabled=!0},r.prototype.disable=function(){this.enabled=!1},r.prototype.toggleEnabled=function(){this.enabled=!this.enabled},r.prototype.toggle=function(e){var r=this;e&&(r=t(e.currentTarget).data("bs."+this.type),r||(r=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,r))),e?(r.inState.click=!r.inState.click,r.isInStateTrue()?r.enter(r):r.leave(r)):r.tip().hasClass("in")?r.leave(r):r.enter(r)},r.prototype.destroy=function(){var t=this;clearTimeout(this.timeout),this.hide(function(){t.$element.off("."+t.type).removeData("bs."+t.type),t.$tip&&t.$tip.detach(),t.$tip=null,t.$arrow=null,t.$viewport=null})};var n=t.fn.tooltip;t.fn.tooltip=e,t.fn.tooltip.Constructor=r,t.fn.tooltip.noConflict=function(){return t.fn.tooltip=n,this}}(jQuery),+function(t){"use strict";function e(e){return this.each(function(){var n=t(this),a=n.data("bs.popover"),o="object"==typeof e&&e;(a||!/destroy|hide/.test(e))&&(a||n.data("bs.popover",a=new r(this,o)),"string"==typeof e&&a[e]())})}var r=function(t,e){this.init("popover",t,e)};if(!t.fn.tooltip)throw new Error("Popover requires tooltip.js");r.VERSION="3.3.5",r.DEFAULTS=t.extend({},t.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),r.prototype=t.extend({},t.fn.tooltip.Constructor.prototype),r.prototype.constructor=r,r.prototype.getDefaults=function(){return r.DEFAULTS},r.prototype.setContent=function(){var t=this.tip(),e=this.getTitle(),r=this.getContent();t.find(".popover-title")[this.options.html?"html":"text"](e),t.find(".popover-content").children().detach().end()[this.options.html?"string"==typeof r?"html":"append":"text"](r),t.removeClass("fade top bottom left right in"),t.find(".popover-title").html()||t.find(".popover-title").hide()},r.prototype.hasContent=function(){return this.getTitle()||this.getContent()},r.prototype.getContent=function(){var t=this.$element,e=this.options;return t.attr("data-content")||("function"==typeof e.content?e.content.call(t[0]):e.content)},r.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")};var n=t.fn.popover;t.fn.popover=e,t.fn.popover.Constructor=r,t.fn.popover.noConflict=function(){return t.fn.popover=n,this}}(jQuery)),MG.chart_title=n,MG.y_rug=a,MG.y_axis=h,MG.y_axis_categorical=g,MG.x_rug=v,MG.x_axis=b,MG.x_axis_categorical=w,MG.init=be,MG.markers=Xe,"undefined"!=typeof jQuery&&+function(t){"use strict";function e(e){e&&3===e.which||(t(a).remove(),t(o).each(function(){var n=t(this),a=r(n),o={relatedTarget:this};a.hasClass("open")&&(a.trigger(e=t.Event("hide.bs.dropdown",o)),e.isDefaultPrevented()||(n.attr("aria-expanded","false"),a.removeClass("open").trigger("hidden.bs.dropdown",o)))}))}function r(e){var r=e.attr("data-target");r||(r=e.attr("href"),r=r&&/#[A-Za-z]/.test(r)&&r.replace(/.*(?=#[^\s]*$)/,""));var n=r&&t(r);return n&&n.length?n:e.parent()}function n(e){return this.each(function(){var r=t(this),n=r.data("bs.dropdown");n||r.data("bs.dropdown",n=new i(this)),"string"==typeof e&&n[e].call(r)})}if("function"==typeof t().dropdown)return!0;var a=".dropdown-backdrop",o='[data-toggle="dropdown"]',i=function(e){t(e).on("click.bs.dropdown",this.toggle)};i.VERSION="3.3.1",i.prototype.toggle=function(n){var a=t(this);if(!a.is(".disabled, :disabled")){var o=r(a),i=o.hasClass("open");if(e(),!i){"ontouchstart"in document.documentElement&&!o.closest(".navbar-nav").length&&t('<div class="dropdown-backdrop"/>').insertAfter(t(this)).on("click",e);var s={relatedTarget:this};if(o.trigger(n=t.Event("show.bs.dropdown",s)),n.isDefaultPrevented())return;a.trigger("focus").attr("aria-expanded","true"),o.toggleClass("open").trigger("shown.bs.dropdown",s)}return!1}},i.prototype.keydown=function(e){if(/(38|40|27|32)/.test(e.which)&&!/input|textarea/i.test(e.target.tagName)){var n=t(this);if(e.preventDefault(),e.stopPropagation(),!n.is(".disabled, :disabled")){var a=r(n),i=a.hasClass("open");if(!i&&27!=e.which||i&&27==e.which)return 27==e.which&&a.find(o).trigger("focus"),n.trigger("click");var s=" li:not(.divider):visible a",l=a.find('[role="menu"]'+s+', [role="listbox"]'+s);if(l.length){var c=l.index(e.target);38==e.which&&c>0&&c--,40==e.which&&c<l.length-1&&c++,~c||(c=0),l.eq(c).trigger("focus")}}}};var s=t.fn.dropdown;t.fn.dropdown=n,t.fn.dropdown.Constructor=i,t.fn.dropdown.noConflict=function(){return t.fn.dropdown=s,this},t(document).on("click.bs.dropdown.data-api",e).on("click.bs.dropdown.data-api",".dropdown form",function(t){t.stopPropagation()}).on("click.bs.dropdown.data-api",o,i.prototype.toggle).on("keydown.bs.dropdown.data-api",o,i.prototype.keydown).on("keydown.bs.dropdown.data-api",'[role="menu"]',i.prototype.keydown).on("keydown.bs.dropdown.data-api",'[role="listbox"]',i.prototype.keydown)}(jQuery),MG.button_layout=function(t){"use strict";return this.target=t,this.feature_set={},this.public_name={},this.sorters={},this.manual=[],this.manual_map={},this.manual_callback={},this._strip_punctuation=function(t){var e=t.replace(/[^a-zA-Z0-9 _]+/g,""),r=e.replace(/ +?/g,"");return r},this.data=function(t){return this._data=t,this},this.manual_button=function(t,e,r){return this.feature_set[t]=e,this.manual_map[this._strip_punctuation(t)]=t,this.manual_callback[t]=r,this},this.button=function(t){return arguments.length>1&&(this.public_name[t]=arguments[1]),arguments.length>2&&(this.sorters[t]=arguments[2]),this.feature_set[t]=[],this},this.callback=function(t){return this._callback=t,this},this.display=function(){var t,r,n,a,o=this._callback,i=this.manual_callback,s=this.manual_map;n=Object.keys(this.feature_set);var l,c=function(e){return t[e]};for(l=0;l<this._data.length;l++){t=this._data[l],r=n.map(c);for(var u=0;u<n.length;u++)a=n[u],-1===this.feature_set[a].indexOf(r[u])&&this.feature_set[a].push(r[u])}for(a in this.feature_set)this.sorters.hasOwnProperty(a)&&this.feature_set[a].sort(this.sorters[a]);e(this.target).empty(),e(this.target).append("<div class='col-lg-12 segments text-center'></div>");var f=function(){var t,r=e(this).data("key"),n=e(this).data("feature");return e("."+n+"-btns button.btn span.title").html(r),s.hasOwnProperty(n)?(t=s[n],i[t](r)):o(n,r),!1};for(var d in this.feature_set){for(n=this.feature_set[d],e(this.target+" div.segments").append('<div class="btn-group '+this._strip_punctuation(d)+'-btns text-left"><button type="button" class="btn btn-default btn-lg dropdown-toggle" data-toggle="dropdown"><span class=\'which-button\'>'+(this.public_name.hasOwnProperty(d)?this.public_name[d]:d)+"</span><span class='title'>"+(this.manual_callback.hasOwnProperty(d)?this.feature_set[d][0]:"all")+'</span><span class="caret"></span></button><ul class="dropdown-menu" role="menu">'+(this.manual_callback.hasOwnProperty(d)?"":'<li><a href="#" data-feature="'+d+'" data-key="all">All</a></li>')+(this.manual_callback.hasOwnProperty(d)?"":'<li class="divider"></li>')+"</ul></div>"),l=0;l<n.length;l++)"all"!==n[l]&&void 0!==n[l]&&e(this.target+" div."+this._strip_punctuation(d)+"-btns ul.dropdown-menu").append('<li><a href="#" data-feature="'+this._strip_punctuation(d)+'" data-key="'+n[l]+'">'+n[l]+"</a></li>");e("."+this._strip_punctuation(d)+"-btns .dropdown-menu li a").on("click",f)}return this},this},function(){"use strict";function e(t,e,i){o(t,e),n(t,e),a(t,e),r(t,e,i)}function r(e,r,n){r.existing_band=n.selectAll(".mg-confidence-band"),e.show_confidence_band&&(r.confidence_area=t.svg.area().defined(r.line.defined()).x(e.scalefns.xf).y0(function(t){var r=e.show_confidence_band[0];return e.scales.Y(t[r])}).y1(function(t){var r=e.show_confidence_band[1];return e.scales.Y(t[r])}).interpolate(e.interpolate).tension(e.interpolate_tension))}function n(e,r){r.area=t.svg.area().defined(r.line.defined()).x(e.scalefns.xf).y0(e.scales.Y.range()[0]).y1(e.scalefns.yf).interpolate(e.interpolate).tension(e.interpolate_tension)}function a(e,r){r.flat_line=t.svg.line().defined(function(t){return(void 0===t._missing||t._missing!==!0)&&null!==t[e.y_accessor]}).x(e.scalefns.xf).y(function(){return e.scales.Y(r.data_median)}).interpolate(e.interpolate).tension(e.interpolate_tension)}function o(e,r){r.line=t.svg.line().x(e.scalefns.xf).y(e.scalefns.yf).interpolate(e.interpolate).tension(e.interpolate_tension),e.missing_is_zero||(r.line=r.line.defined(function(t){return(void 0===t._missing||t._missing!==!0)&&null!==t[e.y_accessor]}))}function i(t,e,r,n){var a;t.show_confidence_band&&(a=e.existing_band.empty()?r.append("path").attr("class","mg-confidence-band"):e.existing_band.transition().duration(function(){return t.transition_on_update?1e3:0}),a.attr("d",e.confidence_area(t.data[n])).attr("clip-path","url(#mg-plot-window-"+Hr(t.target)+")"))}function s(t,e,r,n,a){var o=r.selectAll(".mg-main-area.mg-area"+a);e.display_area?o.empty()?r.append("path").classed("mg-main-area",!0).classed("mg-area"+a,!0).classed("mg-area"+a+"-color",null===t.colors).attr("d",e.area(t.data[n])).attr("fill",null===t.colors?"":t.colors[a-1]).attr("clip-path","url(#mg-plot-window-"+Hr(t.target)+")"):(r.node().appendChild(o.node()),o.transition().duration(e.update_transition_duration).attr("d",e.area(t.data[n])).attr("clip-path","url(#mg-plot-window-"+Hr(t.target)+")")):o.empty()||o.remove()}function l(t,e){t.classed("mg-line"+e+"-color",!0)}function c(t,e,r,n){t.colors&&t.colors.constructor===Array?(e.attr("stroke",t.colors[r]),t.colors.length<r+1&&l(e,n)):l(e,n)}function u(e,r,n,a){e.animate_on_load?(r.data_median=t.median(e.data[a],function(t){return t[e.y_accessor]}),n.attr("d",r.flat_line(e.data[a])).transition().duration(1e3).attr("d",r.line(e.data[a])).attr("clip-path","url(#mg-plot-window-"+Hr(e.target)+")")):n.attr("d",r.line(e.data[a])).attr("clip-path","url(#mg-plot-window-"+Hr(e.target)+")")}function f(t,e,r,n,a,o){if(n.empty()){var i=r.append("path").attr("class","mg-main-line mg-line"+o);c(t,i,a,o),u(t,e,i,a)}else{r.node().appendChild(n.node());var s=n.transition().duration(e.update_transition_duration);!e.display_area&&t.transition_on_update?s.attrTween("d",fr(e.line(t.data[a]),4)):s.attr("d",e.line(t.data[a]))}}function d(t,e,r,n){var a;if(t.legend)if(mr(t.legend)?a=t.legend[r]:hr(t.legend)&&(a=t.legend(t.data[r])),t.legend_target)e.legend_text=t.colors&&t.colors.constructor===Array?"<span style='color:"+t.colors[r]+"'>&mdash; "+a+"&nbsp; </span>"+e.legend_text:"<span class='mg-line"+n+"-legend-color'>&mdash; "+a+"&nbsp; </span>"+e.legend_text;else{var o=t.data[r][t.data[r].length-1],i=e.legend_group.append("svg:text").attr("x",t.scalefns.xf(o)).attr("dx",t.buffer).attr("y",t.scalefns.yf(o)).attr("dy",".35em").attr("font-size",10).attr("font-weight","300").text(a);t.colors&&t.colors.constructor===Array?t.colors.length<r+1?i.classed("mg-line"+n+"-legend-color",!0):i.attr("fill",t.colors[r]):i.classed("mg-line"+n+"-legend-color",!0),Nr(e.legend_group.selectAll(".mg-line-legend text")[0],t)}}function p(e,r){e&&t.select(e).html(r)}function m(t,e,r){t.legend&&(e.legend_group=zr(r,"mg-line-legend"))}function _(t){Yr(t,".mg-rollover-rect"),Yr(t,".mg-voronoi"),Yr(t,".mg-active-datapoint"),Yr(t,".mg-line-rollover-circle"),Yr(t,".mg-active-datapoint-container")}function g(e,r){var n=zr(r,"mg-active-datapoint-container").append("text").attr("class","mg-active-datapoint").attr("xml:space","preserve").attr("text-anchor","end"),a=.75;if(e.markers){var o;r.selectAll(".mg-marker-text").each(function(){o?o!==t.select(this).attr("y")&&(a=.56):o=t.select(this).attr("y")})}n.attr("transform","translate("+Tr(e)+","+kr(e)*a+")")}function v(t,e){var r=e.selectAll(".mg-line-rollover-circle").data(t.data).enter().append("circle").attr({cx:0,cy:0,r:0});t.colors&&t.colors.constructor===Array?r.attr("class",function(t){return"mg-line"+t.line_id}).attr("fill",function(e,r){return t.colors[r]}).attr("stroke",function(e,r){return t.colors[r]}):r.attr("class",function(t){return["mg-line"+t.line_id,"mg-line"+t.line_id+"-color","mg-area"+t.line_id+"-color"].join(" ")}),r.classed("mg-line-rollover-circle",!0)}function x(t){for(var e=1,r=0;r<t.data.length;r++){for(var n=0;n<t.data[r].length;n++)t.data[r][n].line_id=t.custom_line_color_map.length>0?t.custom_line_color_map[r]:e;e++}}function y(e){return t.nest().key(function(t){return e.scales.X(t[e.x_accessor])+","+e.scales.Y(t[e.y_accessor])}).rollup(function(t){return t[0]}).entries(t.merge(e.data.map(function(t){return t}))).map(function(t){return t.values})}function w(t){return function(e){var r;if(t.linked){var n=e[t.x_accessor],a=MG.time_format(t.utc_time,t.linked_format),o="number"==typeof n?e.line_id-1:a(n);return r="roll_"+o+" mg-line"+e.line_id,null===t.color&&(r+=" mg-line"+e.line_id+"-color"),r}return r="mg-line"+e.line_id,null===t.color&&(r+=" mg-line"+e.line_id+"-color"),r}}function k(e,r,n,a,o){var i=t.geom.voronoi().x(function(t){return e.scales.X(t[e.x_accessor]).toFixed(2)}).y(function(t){return e.scales.Y(t[e.y_accessor]).toFixed(2)}).clipExtent([[e.buffer,e.buffer+e.title_y_position],[e.width-e.buffer,e.height-e.buffer]]),s=zr(r,"mg-voronoi");s.selectAll("path").data(i(y(e))).enter().append("path").filter(function(t){return void 0!==t&&t.length>0}).attr("d",function(t){return"M"+t.join("L")+"Z"}).datum(function(t){return t.point}).attr("class",w(e)).on("mouseover",n).on("mouseout",a).on("mousemove",o),D(e,r)}function M(e){var r=t.nest().key(function(t){return t[e.x_accessor]}).entries(t.merge(e.data));return r.forEach(function(t){var r=t.values[0];t.key=r[e.x_accessor]}),e.x_sort?r.sort(function(t,e){return new Date(t.key)-new Date(e.key)}):r}function A(t,e,r,n,a){var o=M(t),i=o.map(function(e){return t.scales.X(e.key)}),s=e.append("g").attr("class","mg-rollover-rect");s.selectAll(".mg-rollover-rects").data(o).enter().append("rect").attr("x",function(e,r){return 1===i.length?Gr(t):0===r?i[r].toFixed(2):((i[r-1]+i[r])/2).toFixed(2)}).attr("y",t.top).attr("width",function(e,r){return 1===i.length?Tr(t):0===r?((i[r+1]-i[r])/2).toFixed(2):r===i.length-1?((i[r]-i[r-1])/2).toFixed(2):((i[r+1]-i[r-1])/2).toFixed(2)}).attr("class",function(e){var r=e.values.map(function(r){var n=T(e.line_id);return null===t.colors&&(n+=" "+O(r.line_id)),n}).join(" ");return t.linked&&e.values.length>0&&(r+=" "+Y(z(e.values[0],0,t))),r}).attr("height",t.height-t.bottom-t.top-t.buffer).attr("opacity",0).on("mouseover",r).on("mouseout",n).on("mousemove",a),E(t,e)}function G(t,e){e.select(".mg-rollover-rect rect").on("mouseover")(t.data[0][0],0)}function D(t,e){for(var r=0;r<t.data.length;r++){var n=r+1;t.custom_line_color_map.length>0&&void 0!==t.custom_line_color_map[r]&&(n=t.custom_line_color_map[r]),1!==t.data[r].length||e.selectAll(".mg-voronoi .mg-line"+n).empty()||(e.selectAll(".mg-voronoi .mg-line"+n).on("mouseover")(t.data[r][0],0),e.selectAll(".mg-voronoi .mg-line"+n).on("mouseout")(t.data[r][0],0))}}function T(t){return"mg-line"+t}function O(t){return"mg-line"+t+"-color"}function Y(t){return"roll_"+t}function z(t,e,r){var n=t[r.x_accessor],a=MG.time_format(r.utc_time,r.linked_format),o="number"==typeof n?e:a(n);return o}function C(t,e,r,n,a){var o=1;t.custom_line_color_map.length>0&&(o=t.custom_line_color_map[0]);var i=e.append("g").attr("class","mg-rollover-rect"),s=t.data[0].map(t.scalefns.xf);i.selectAll(".mg-rollover-rects").data(t.data[0]).enter().append("rect").attr("class",function(e,r){var n=O(o)+" "+T(e.line_id);return t.linked&&(n+=n+" "+Y(z(e,r,t))),n}).attr("x",function(e,r){return 1===s.length?Gr(t):0===r?s[r].toFixed(2):((s[r-1]+s[r])/2).toFixed(2)}).attr("y",function(e){return t.data.length>1?t.scalefns.yf(e)-6:t.top}).attr("width",function(e,r){return 1===s.length?Tr(t):0===r?((s[r+1]-s[r])/2).toFixed(2):r===s.length-1?((s[r]-s[r-1])/2).toFixed(2):((s[r+1]-s[r-1])/2).toFixed(2)}).attr("height",function(){return t.data.length>1?12:t.height-t.bottom-t.top-t.buffer}).attr("opacity",0).on("mouseover",r).on("mouseout",n).on("mousemove",a),$(t)&&G(t,e)}function E(t,e){var r=e.selectAll(".mg-rollover-rect rect");t.data.filter(function(t){return 1===t.length}).length>0&&r.on("mouseover")(r[0][0].__data__,0)}function F(t){return t.data.length>1&&!t.aggregate_rollover}function X(t){return t.data.length>1&&t.aggregate_rollover}function $(t){return 1===t.data.length&&1===t.data[0].length}function P(t,e,r){for(var n=t.data.length-1;n>=0;n--){var a=t.data[n];MG.call_hook("line.before_each_series",[a,t]);var o=n+1;if(t.custom_line_color_map.length>0&&(o=t.custom_line_color_map[n]),t.data[n].line_id=o,0!==a.length){var l=r.select("path.mg-main-line.mg-line"+o);i(t,e,r,n),s(t,e,r,n,o),f(t,e,r,l,n,o),d(t,e,n,o),MG.call_hook("line.after_each_series",[a,l,t])}}}function S(t){var r={},n=Rr(t.target);Yr(n,".mg-line-legend"),m(t,r,n),r.data_median=0,r.update_transition_duration=t.transition_on_update?1e3:0,r.display_area=t.area&&!t.use_data_y_min&&t.data.length<=1,r.legend_text="",e(t,r,n),r.existing_band=n.selectAll(".mg-confidence-band");var a=MG.call_hook("line.before_all_series",[t]);a!==!1&&P(t,r,n),p(t.legend_target,r.legend_text)}function j(t,e){var r=Rr(t.target);_(r),g(t,r),v(t,r),x(t),F(t)?k(t,r,e.rolloverOn(t),e.rolloverOff(t),e.rolloverMove(t)):X(t)?A(t,r,e.rolloverOn(t),e.rolloverOff(t),e.rolloverMove(t)):C(t,r,e.rolloverOn(t),e.rolloverOff(t),e.rolloverMove(t))}function N(t,e,r){if(t.aggregate_rollover&&t.data.length>1)e.selectAll("circle.mg-line-rollover-circle").style("opacity",0),r.values.forEach(function(r){pr(r,t)&&L(t,e,r)});else{if(t.missing_is_hidden&&r._missing||null===r[t.y_accessor])return;pr(r,t)&&I(t,e,r)}}function L(t,e,r){e.select("circle.mg-line-rollover-circle.mg-line"+r.line_id).attr({cx:function(){return t.scales.X(r[t.x_accessor]).toFixed(2)},cy:function(){return t.scales.Y(r[t.y_accessor]).toFixed(2)},r:t.point_size}).style("opacity",1)}function I(t,e,r){e.selectAll("circle.mg-line-rollover-circle.mg-line"+r.line_id).classed("mg-line-rollover-circle",!0).attr("cx",function(){return t.scales.X(r[t.x_accessor]).toFixed(2)}).attr("cy",function(){return t.scales.Y(r[t.y_accessor]).toFixed(2)}).attr("r",t.point_size).style("opacity",1)}function R(e,r,n){if(e.linked&&!MG.globals.link&&(MG.globals.link=!0,!e.aggregate_rollover||void 0!==r.value||r.values.length>0)){var a=r.values?r.values[0]:r,o=z(a,n,e);t.selectAll("."+T(a.line_id)+"."+Y(o)).each(function(e){t.select(this).on("mouseover")(e,n)})}}function B(e,r,n){if(e.linked&&MG.globals.link){MG.globals.link=!1;var a=MG.time_format(e.utc_time,e.linked_format),o=r.values?r.values:[r];o.forEach(function(r){var o=r[e.x_accessor],i="number"==typeof o?n:a(o);t.selectAll(".roll_"+i).each(function(e){t.select(this).on("mouseout")(e)})})}}function q(t,e){e.selectAll("circle.mg-line-rollover-circle").style("opacity",0)}function H(t,e,r){e.selectAll("circle.mg-line-rollover-circle.mg-line"+r.line_id).style("opacity",function(){var e=r.line_id-1;return t.custom_line_color_map.length>0&&void 0!==t.custom_line_color_map.indexOf(r.line_id)&&(e=t.custom_line_color_map.indexOf(r.line_id)),1===t.data[e].length?1:0})}function U(t){t.select(".mg-active-datapoint").text("")}function Q(t){this.init=function(t){return this.args=t,t.data&&0!==t.data.length?(t.internal_error=void 0,Be(t),He(t),be(t),b(t),h(t),this.markers(),this.mainPlot(),this.rollover(),this.windowListeners(),MG.call_hook("line.after_init",this),this):(t.internal_error="No data was supplied",nn(t),this)},this.mainPlot=function(){return S(t),this},this.markers=function(){return Xe(t),this},this.rollover=function(){var e=this;return j(t,e),MG.call_hook("line.after_rollover",t),this},this.rolloverOn=function(t){var e=Rr(t.target),r=dr(t);return function(n,a){N(t,e,n),R(t,n,a),e.selectAll("text").filter(function(t){return n===t
}).attr("opacity",.3),t.show_rollover_text&&Le(t,e,r,"‚Äî ",n,a),t.mouseover&&t.mouseover(n,a)}},this.rolloverOff=function(t){var e=Rr(t.target);return function(r,n){B(t,r,n),t.aggregate_rollover?q(t,e):H(t,e,r),U(e),t.mouseout&&t.mouseout(r,n)}},this.rolloverMove=function(t){return function(e,r){t.mousemove&&t.mousemove(e,r)}},this.windowListeners=function(){return Ie(this.args),this},this.init(t)}MG.register("line",Q)}.call(this),function(){"use strict";function r(r){this.init=function(t){return this.args=t,Be(t),Ue(t),be(t),b(t),h(t),this.mainPlot(),this.markers(),this.rollover(),this.windowListeners(),this},this.mainPlot=function(){var t=Rr(r.target);t.selectAll(".mg-histogram").remove();var e=t.append("g").attr("class","mg-histogram"),n=e.selectAll(".mg-bar").data(r.data[0]).enter().append("g").attr("class","mg-bar").attr("transform",function(t){return"translate("+r.scales.X(t[r.x_accessor]).toFixed(2)+","+r.scales.Y(t[r.y_accessor]).toFixed(2)+")"});return n.append("rect").attr("x",1).attr("width",function(){return 1===r.data[0].length?(r.scalefns.xf(r.data[0][0])-r.bar_margin).toFixed(2):(r.scalefns.xf(r.data[0][1])-r.scalefns.xf(r.data[0][0])-r.bar_margin).toFixed(2)}).attr("height",function(t){return 0===t[r.y_accessor]?0:(r.height-r.bottom-r.buffer-r.scales.Y(t[r.y_accessor])).toFixed(2)}),this},this.markers=function(){return Xe(r),this},this.rollover=function(){{var t=Rr(r.target);e(e(r.target).find("svg").get(0))}t.selectAll(".mg-rollover-rect").remove(),t.selectAll(".mg-active-datapoint").remove(),t.append("text").attr("class","mg-active-datapoint").attr("xml:space","preserve").attr("x",r.width-r.right).attr("y",.75*r.top).attr("text-anchor","end");var n=t.append("g").attr("class","mg-rollover-rect"),a=n.selectAll(".mg-bar").data(r.data[0]).enter().append("g").attr("class",function(t,e){return r.linked?"mg-rollover-rects roll_"+e:"mg-rollover-rects"}).attr("transform",function(t){return"translate("+r.scales.X(t[r.x_accessor])+",0)"});return a.append("rect").attr("x",1).attr("y",r.buffer+r.title_y_position).attr("width",function(t,e){return 1===r.data[0].length?(r.scalefns.xf(r.data[0][0])-r.bar_margin).toFixed(2):e!==r.data[0].length-1?(r.scalefns.xf(r.data[0][e+1])-r.scalefns.xf(t)).toFixed(2):(r.scalefns.xf(r.data[0][1])-r.scalefns.xf(r.data[0][0])).toFixed(2)}).attr("height",function(){return r.height}).attr("opacity",0).on("mouseover",this.rolloverOn(r)).on("mouseout",this.rolloverOff(r)).on("mousemove",this.rolloverMove(r)),this},this.rolloverOn=function(e){var r=Rr(e.target);return function(n,a){r.selectAll("text").filter(function(t){return n===t}).attr("opacity",.3);var o=e.processed.xax_format||MG.time_format(e.utc_time,"%b %e, %Y"),i=lr(e);r.selectAll(".mg-bar rect").filter(function(t,e){return e===a}).classed("active",!0),e.linked&&!MG.globals.link&&(MG.globals.link=!0,t.selectAll(".mg-rollover-rects.roll_"+a+" rect").each(function(e){t.select(this).on("mouseover")(e,a)})),e.show_rollover_text&&r.select(".mg-active-datapoint").text(function(){if(e.time_series){var t=new Date(+n[e.x_accessor]);return t.setDate(t.getDate()),o(t)+"  "+e.yax_units+i(n[e.y_accessor])}return e.x_accessor+": "+i(n[e.x_accessor])+", "+e.y_accessor+": "+e.yax_units+i(n[e.y_accessor])}),e.mouseover&&e.mouseover(n,a)}},this.rolloverOff=function(e){var r=Rr(e.target);return function(n,a){e.linked&&MG.globals.link&&(MG.globals.link=!1,t.selectAll(".mg-rollover-rects.roll_"+a+" rect").each(function(e){t.select(this).on("mouseout")(e,a)})),r.selectAll(".mg-bar rect").classed("active",!1),r.select(".mg-active-datapoint").text(""),e.mouseout&&e.mouseout(n,a)}},this.rolloverMove=function(t){return function(e,r){t.mousemove&&t.mousemove(e,r)}},this.windowListeners=function(){return Ie(this.args),this},this.init(r)}var n={mouseover:function(e){t.select("#histogram svg .mg-active-datapoint").text("Frequency Count: "+e.y)},binned:!1,bins:null,processed_x_accessor:"x",processed_y_accessor:"y",processed_dx_accessor:"dx",bar_margin:1};MG.register("histogram",r,n)}.call(this),function(){"use strict";function e(e){this.init=function(t){return this.args=t,Be(t),Ze(t),be(t),b(t),h(t),this.mainPlot(),this.markers(),this.rollover(),this.windowListeners(),this},this.markers=function(){return Xe(e),e.least_squares&&Ve(e),this},this.mainPlot=function(){var t,r=Rr(e.target);r.selectAll(".mg-points").remove(),t=r.append("g").classed("mg-points",!0);var n=t.selectAll("circle").data(e.data[0]).enter().append("svg:circle").attr("class",function(t,e){return"path-"+e}).attr("cx",e.scalefns.xf).attr("cy",e.scalefns.yf);return null!==e.color_accessor?(n.attr("fill",e.scalefns.color),n.attr("stroke",e.scalefns.color)):n.classed("mg-points-mono",!0),null!==e.size_accessor?n.attr("r",e.scalefns.size):n.attr("r",e.point_size),this},this.rollover=function(){var r=Rr(e.target);r.selectAll(".mg-voronoi").remove(),r.selectAll(".mg-active-datapoint").remove(),r.append("text").attr("class","mg-active-datapoint").attr("xml:space","preserve").attr("x",e.width-e.right).attr("y",.75*e.top).attr("text-anchor","end");var n=t.geom.voronoi().x(e.scalefns.xf).y(e.scalefns.yf).clipExtent([[e.buffer,e.buffer+e.title_y_position],[e.width-e.buffer,e.height-e.buffer]]),a=r.append("g").attr("class","mg-voronoi");return a.selectAll("path").data(n(e.data[0])).enter().append("path").attr("d",function(t){return void 0!==t?"M"+t.join(",")+"Z":void 0}).attr("class",function(t,e){return"path-"+e}).style("fill-opacity",0).on("mouseover",this.rolloverOn(e)).on("mouseout",this.rolloverOff(e)).on("mousemove",this.rolloverMove(e)),this},this.rolloverOn=function(e){var r=Rr(e.target);return function(n,a){r.selectAll(".mg-points circle").classed("selected",!1);var o=r.selectAll(".mg-points circle.path-"+a).classed("selected",!0);if(e.size_accessor?o.attr("r",function(t){return e.scalefns.size(t)+e.active_point_size_increase}):o.attr("r",e.point_size+e.active_point_size_increase),e.linked&&!MG.globals.link&&(MG.globals.link=!0,t.selectAll(".mg-voronoi .path-"+a).each(function(){t.select(this).on("mouseover")(n,a)})),e.show_rollover_text){var i=MG.time_format(e.utc_time,"%b %e, %Y");Le(e,r,i,"‚Ä¢",n.point,a)}e.mouseover&&e.mouseover(n,a)}},this.rolloverOff=function(e){var r=Rr(e.target);return function(n,a){e.linked&&MG.globals.link&&(MG.globals.link=!1,t.selectAll(".mg-voronoi .path-"+a).each(function(){t.select(this).on("mouseout")(n,a)}));var o=r.selectAll(".mg-points circle").classed("unselected",!1).classed("selected",!1);e.size_accessor?o.attr("r",e.scalefns.size):o.attr("r",e.point_size),r.select(".mg-active-datapoint").text(""),e.mouseout&&e.mouseout(n,a)}},this.rolloverMove=function(t){return function(e,r){t.mousemove&&t.mousemove(e,r)}},this.update=function(){return this},this.windowListeners=function(){return Ie(this.args),this},this.init(e)}var r={buffer:16,ls:!1,lowess:!1,point_size:2.5,label_accessor:null,size_accessor:null,color_accessor:null,size_range:null,color_range:null,size_domain:null,color_domain:null,active_point_size_increase:1,color_type:"number"};MG.register("point",e,r)}.call(this),function(){"use strict";function t(t){this.args=t,this.init=function(t){return this.args=t,Be(t),Qe(t),be(t),this.is_vertical="vertical"===t.bar_orientation,this.is_vertical?(w(t),h(t)):(b(t),g(t)),this.mainPlot(),this.markers(),this.rollover(),this.windowListeners(),this},this.mainPlot=function(){var e,r,n,a,o,i=Rr(t.target),s=t.data[0],l=i.select("g.mg-barplot"),c=l.empty(),u=c&&t.animate_on_load,f=u||t.transition_on_update,d=t.transition_duration||1e3;c&&(l=i.append("g").classed("mg-barplot",!0)),e=e=l.selectAll(".mg-bar").data(s),e.exit().remove(),e.enter().append("rect").classed("mg-bar",!0),t.predictor_accessor&&(r=l.selectAll(".mg-bar-prediction").data(s),r.exit().remove(),r.enter().append("rect").classed("mg-bar-prediction",!0)),t.baseline_accessor&&(o=l.selectAll(".mg-bar-baseline").data(s),o.exit().remove(),o.enter().append("line").classed("mg-bar-baseline",!0));var p;return f&&(e=e.transition().duration(d),r&&(r=r.transition().duration(d)),o&&(o=o.transition().duration(d))),i.select(".mg-y-axis").node().parentNode.appendChild(l.node()),this.is_vertical?(p=t.scales.X.rangeBand()/1.5,u&&(e.attr({height:0,y:t.scales.Y(0)}),r&&r.attr({height:0,y:t.scales.Y(0)}),o&&o.attr({y1:t.scales.Y(0),y2:t.scales.Y(0)})),e.attr("y",t.scalefns.yf).attr("x",function(e){return t.scalefns.xf(e)+p/2}).attr("width",p).attr("height",function(e){return 0-(t.scalefns.yf(e)-t.scales.Y(0))}),t.predictor_accessor&&(n=t.predictor_proportion,a=n-1,r.attr("y",function(e){return t.scales.Y(0)-(t.scales.Y(0)-t.scales.Y(e[t.predictor_accessor]))}).attr("x",function(e){return t.scalefns.xf(e)+a*p/(2*n)+p/2}).attr("width",p/n).attr("height",function(e){return 0-(t.scales.Y(e[t.predictor_accessor])-t.scales.Y(0))})),t.baseline_accessor&&(n=t.predictor_proportion,o.attr("x1",function(e){return t.scalefns.xf(e)+p/2-p/n+p/2}).attr("x2",function(e){return t.scalefns.xf(e)+p/2+p/n+p/2}).attr("y1",function(e){return t.scales.Y(e[t.baseline_accessor])}).attr("y2",function(e){return t.scales.Y(e[t.baseline_accessor])}))):(p=t.scales.Y.rangeBand()/1.5,u&&(e.attr("width",0),r&&r.attr("width",0),o&&o.attr({x1:t.scales.X(0),x2:t.scales.X(0)})),e.attr("x",t.scales.X(0)).attr("y",function(e){return t.scalefns.yf(e)+p/2}).attr("height",p).attr("width",function(e){return t.scalefns.xf(e)-t.scales.X(0)}),t.predictor_accessor&&(n=t.predictor_proportion,a=n-1,r.attr("x",t.scales.X(0)).attr("y",function(e){return t.scalefns.yf(e)+a*p/(2*n)+p/2}).attr("height",p/n).attr("width",function(e){return t.scales.X(e[t.predictor_accessor])-t.scales.X(0)})),t.baseline_accessor&&(n=t.predictor_proportion,o.attr("x1",function(e){return t.scales.X(e[t.baseline_accessor])}).attr("x2",function(e){return t.scales.X(e[t.baseline_accessor])}).attr("y1",function(e){return t.scalefns.yf(e)+p/2-p/n+p/2}).attr("y2",function(e){return t.scalefns.yf(e)+p/2+p/n+p/2}))),this},this.markers=function(){return Xe(t),this},this.rollover=function(){var e,r=Rr(t.target);r.selectAll(".mg-rollover-rect").remove(),r.selectAll(".mg-active-datapoint").remove(),r.append("text").attr("class","mg-active-datapoint").attr("xml:space","preserve").attr("x",t.width-t.right).attr("y",.75*t.top).attr("dy",".35em").attr("text-anchor","end"),e=r.append("g").attr("class","mg-rollover-rect");var n=e.selectAll(".mg-bar-rollover").data(t.data[0]).enter().append("rect").attr("class","mg-bar-rollover");return this.is_vertical?n.attr("x",t.scalefns.xf).attr("y",function(){return t.scales.Y(0)-t.height}).attr("width",t.scales.X.rangeBand()).attr("height",t.height).attr("opacity",0).on("mouseover",this.rolloverOn(t)).on("mouseout",this.rolloverOff(t)).on("mousemove",this.rolloverMove(t)):n.attr("x",t.scales.X(0)).attr("y",t.scalefns.yf).attr("width",t.width).attr("height",t.scales.Y.rangeBand()+2).attr("opacity",0).on("mouseover",this.rolloverOn(t)).on("mouseout",this.rolloverOff(t)).on("mousemove",this.rolloverMove(t)),this},this.rolloverOn=function(t){var e=Rr(t.target),r=this.is_vertical?t.x_accessor:t.y_accessor,n=this.is_vertical?t.y_accessor:t.x_accessor,a=this.is_vertical?t.yax_units:t.xax_units;return function(o,i){e.selectAll("text").filter(function(t){return o===t}).attr("opacity",.3);var s=MG.time_format(t.utc_time,"%b %e, %Y"),l=lr(t);e.selectAll("g.mg-barplot .mg-bar").filter(function(t,e){return e===i}).classed("active",!0),t.show_rollover_text&&e.select(".mg-active-datapoint").text(function(){if(t.time_series){var e=new Date(+o[n]);return e.setDate(e.getDate()),s(e)+"  "+a+l(o[r])}return o[r]+": "+l(o[n])}),t.mouseover&&t.mouseover(o,i)}},this.rolloverOff=function(t){var e=Rr(t.target);return function(r,n){e.selectAll("g.mg-barplot .mg-bar").classed("active",!1),e.select(".mg-active-datapoint").text(""),t.mouseout&&t.mouseout(r,n)}},this.rolloverMove=function(t){return function(e,r){t.mousemove&&t.mousemove(e,r)}},this.windowListeners=function(){return Ie(this.args),this},this.init(t)}var e={y_accessor:"factor",x_accessor:"value",baseline_accessor:null,predictor_accessor:null,predictor_proportion:5,dodge_accessor:null,binned:!0,padding_percentage:0,outer_padding_percentage:.1,height:500,bar_height:20,top:45,left:70,truncate_x_labels:!0,truncate_y_labels:!0,rotate_x_labels:0,rotate_y_labels:0};MG.register("bar",t,e)}.call(this),MG.data_table=function(r){"use strict";return this.args=r,this.args.standard_col={width:150,font_size:12,font_weight:"normal"},this.args.columns=[],this.formatting_options=[["color","color"],["font-weight","font_weight"],["font-style","font_style"],["font-size","font_size"]],this._strip_punctuation=function(t){var e=t.replace(/[^a-zA-Z0-9 _]+/g,""),r=e.replace(/ +?/g,"");return r},this._format_element=function(t,e,r){this.formatting_options.forEach(function(n){var a=n[0],o=n[1];r[o]&&t.style(a,"string"==typeof r[o]||"number"==typeof r[o]?r[o]:r[o](e))})},this._add_column=function(t,e){var r=this.args.standard_col,n=Wr(MG.clone(t),MG.clone(r));n.type=e,this.args.columns.push(n)},this.target=function(){var t=arguments[0];return this.args.target=t,this},this.title=function(){return this._add_column(arguments[0],"title"),this},this.text=function(){return this._add_column(arguments[0],"text"),this},this.bullet=function(){return this},this.sparkline=function(){return this},this.number=function(){return this._add_column(arguments[0],"number"),this},this.display=function(){var r=this.args;n(r);var a,o,i,s,l,c,u,f,d,p,m,h,_=r.target,g=t.select(_).append("table").classed("mg-data-table",!0),v=g.append("colgroup"),x=g.append("thead"),y=g.append("tbody");for(i=x.append("tr"),h=0;h<r.columns.length;h++){var b=r.columns[h];c=b.type,f=b.label,f=void 0===f?"":f,s=i.append("th").style("width",b.width).style("text-align","title"===c?"left":"right").text(f),r.show_tooltips&&b.description&&(s.append("i").classed("fa",!0).classed("fa-question-circle",!0).classed("fa-inverse",!0),e(s[0]).popover({html:!0,animation:!1,content:b.description,trigger:"hover",placement:"top",container:e(s[0])}))}for(h=0;h<r.columns.length;h++)m=v.append("col"),"number"===r.columns[h].type&&m.attr("align","char").attr("char",".");for(var w=0;w<r.data.length;w++){i=y.append("tr");for(var k=0;k<r.columns.length;k++){if(a=r.columns[k],l=a.accessor,u=d=r.data[w][l],c=a.type,"number"===c){if(a.hasOwnProperty("round")&&!a.hasOwnProperty("format")&&(d=t.format("0,."+a.round+"f")(d)),a.hasOwnProperty("value_formatter")&&(d=a.value_formatter(d)),a.hasOwnProperty("format")){a.round&&(d=t.round(d,a.round));var M,A=a.format;"percentage"===A&&(M=t.format("%p")),"count"===A&&(M=t.format("0,000")),"temperature"===A&&(M=function(t){return t+"¬∞"}),d=M(d)}a.hasOwnProperty("currency")&&(d=a.currency+d)}p=i.append("td").classed("table-"+c,!0).classed("table-"+c+"-"+this._strip_punctuation(l),!0).attr("data-value",u).style("width",a.width).style("text-align","title"===c||"text"===c?"left":"right"),this._format_element(p,u,a),"title"===c?(o=p.append("div").text(d),this._format_element(o,d,a),r.columns[k].hasOwnProperty("secondary_accessor")&&p.append("div").text(r.data[w][r.columns[k].secondary_accessor]).classed("secondary-title",!0)):p.text(d)}}return this},this},function(){"use strict";function e(t,e){t.selectAll(".mg-missing-text").data([e.missing_text]).enter().append("text").attr("class","mg-missing-text").attr("x",e.width/2).attr("y",e.height/2).attr("dy",".50em").attr("text-anchor","middle").text(e.missing_text)}function r(e){e.scales.X=t.scale.linear().domain([0,e.data.length]).range([Gr(e),Tr(e)]),e.scalefns.yf=function(t){return e.scales.Y(t.y)}}function a(e){e.scales.Y=t.scale.linear().domain([-2,2]).range([e.height-e.bottom-2*e.buffer,e.top]),e.scalefns.xf=function(t){return e.scales.X(t.x)}}function o(t){for(var e=[],r=1;50>=r;r++)e.push({x:r,y:Math.random()-.03*r});t.data=e}function i(t,e){t.append("svg:rect").classed("mg-missing-background",!0).attr("x",e.buffer).attr("y",e.buffer).attr("width",e.width-2*e.buffer).attr("height",e.height-2*e.buffer).attr("rx",15).attr("ry",15)}function s(e,r){var n=t.svg.line().x(r.scalefns.xf).y(r.scalefns.yf).interpolate(r.interpolate);e.append("path").attr("class","mg-main-line mg-line1-color").attr("d",n(r.data))}function l(e,r){var n=t.svg.area().x(r.scalefns.xf).y0(r.scales.Y.range()[0]).y1(r.scalefns.yf).interpolate(r.interpolate);e.append("path").attr("class","mg-main-area mg-area1-color").attr("d",n(r.data))}function c(e){t.select(e.target).selectAll("svg *").remove()}function u(e){e.legend_target&&t.select(e.legend_target).html("")}function f(f){this.init=function(f){this.args=f,fe(f),de(f),n(f);var d=t.select(f.target);ye(d,f);var p=d.selectAll("svg");if(pe(p,f),p=me(p,f),_e(p,f),ge(p,f),c(f),p.classed("mg-missing",!0),u(f),f.show_missing_background){o(f),r(f),a(f);var m=zr(p,"mg-missing-pane");i(m,f),s(m,f),l(m,f)}return e(p,f),this.windowListeners(),this},this.windowListeners=function(){return Ie(this.args),this},this.init(f)}var d={top:40,bottom:30,right:10,left:10,buffer:8,legend_target:"",width:350,height:220,missing_text:"Data currently missing or unavailable",scalefns:{},scales:{},show_tooltips:!0,show_missing_background:!0,interpolate:"cardinal"};MG.register("missing-data",f,d)}.call(this),MG.raw_data_transformation=Be,MG.process_line=He,MG.process_histogram=Ue,MG.process_categorical_variables=Qe,MG.process_point=Ze,MG.add_ls=Ve,MG.add_lowess=We,MG.lowess_robust=Je,MG.lowess=Ke,MG.least_squares=tr;var an=function(t,e,r,n){var a;return a="string"==typeof t?MG.time_format(n,t)(e[r]):"function"==typeof t?t(e):e[r]},on=function(e,r,n){var a;return a="string"==typeof e?t.format(e)(r[n]):"function"==typeof e?e(r):r[n]};MG.format_rollover_number=lr,MG.path_tween=fr,MG.convert={},MG.convert.date=function(e,r,n){return n="undefined"==typeof n?"%Y-%m-%d":n,e=e.map(function(e){var a=t.time.format(n);return e[r]=a.parse(e[r]),e})},MG.convert.number=function(t,e){return t=t.map(function(t){return t[e]=Number(t[e]),t})},MG.time_format=function(e,r){return e?t.time.format.utc(r):t.time.format(r)};var sn=function(t,e,r){var n={};if(null===t)return t;if(Array.prototype.forEach&&t.forEach===Array.prototype.forEach)t.forEach(e,r);else if(t.length===+t.length){for(var a=0,o=t.length;o>a;a++)if(e.call(r,t[a],a,t)===n)return}else for(var i in t)if(e.call(r,t[i],i,t)===n)return;return t};return MG.merge_with_defaults=Wr,MG.clone=function(t){var e;if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return e=new Date,e.setTime(t.getTime()),e;if(t instanceof Array){e=[];for(var r=0,n=t.length;n>r;r++)e[r]=MG.clone(t[r]);return e}if(t instanceof Object){e={};for(var a in t)t.hasOwnProperty(a)&&(e[a]=MG.clone(t[a]));return e}throw new Error("Unable to copy obj! Its type isn't supported.")},MG.arr_diff=Jr,MG.warn_deprecation=Kr,MG.truncate_text=tn,MG.wrap_text=en,MG.error=rn,MG});

  console.log(window.MG);
  
  RED.nodes.registerType('metrics graphics', {
    category: 'output',
    color: '#a0c5e4',
    defaults: {
      name: { value: '' },
      column: { value: '20' },
      routes: { value: [] }
    },
    inputs: 1,
    outputs: 1,
    icon: 'chart-icon.png',
    label: function () {
      return this.name || 'metrics graphics';
    },
    oneditprepare: function () {
      var node = this;
      function generateRoute (i, route) {
        var container = $('<li/>', {'class': 'route-container'});
        var row = $('<div/>').appendTo(container);
        $('<i/>', {'class': 'node-input-route-handle fa fa-bars'}).appendTo(row);
        $('<span/>', {'class': 'node-input-route-index'}).html(i).appendTo(row);
        $('<input/>', {'type': 'text', 'class': 'node-input-route-key', 'placeholder': 'Key', 'value': route.key}).appendTo(row);
        $('<input/>', {'type': 'text', 'class': 'node-input-route-legend', 'placeholder': 'Legend', 'value': route.legend}).appendTo(row);
        var finalspan = $('<span/>', {'class': 'finalspan'}).appendTo(row);
        var deleteButton = $('<a/>',{'href': '#', 'class': 'editor-button editor-button-small'}).appendTo(finalspan);
        $('<i/>', {'class': 'fa fa-remove'}).appendTo(deleteButton);
        deleteButton.click(function () {
          container.css({'background': '#fee'});
          container.fadeOut(300, function () {
            $(this).remove();
            $("#node-input-route-container").children().each(function (i) {
              $(this).find('.node-input-route-index').html(i + 1);
            });
          });
        });
        $("#node-input-route-container").append(container);
      }
      $(".chart-play").click(function () {
        changeState(node, 'enable');
      });
      $(".chart-pause").click(function () {
        changeState(node, 'disable');
      });
      $(".chart-refresh").click(function () {
        changeState(node, 'refresh');
      });
      $(".chart-clear").click(function () {
        clearChart(node);
      });
      $("#node-input-add-route").click(function () {
        generateRoute($("#node-input-route-container").children().length + 1, {'key': '', 'legend': ''});
        $("#node-input-route-container-div").scrollTop($("#node-input-route-container-div").get(0).scrollHeight);
      });
      for (var i = 0; i < this.routes.length; i++) {
        generateRoute(i + 1, this.routes[i]);
      }
      function chartDialogResize () {
        var rows = $("#dialog-form>div:not(.node-input-route-container-row)");
        var height = $("#dialog-form").height();
        for (var i = 0; i < rows.size(); i++) {
          height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-route-container-row");
        height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')));
        $("#node-input-route-container-div").css('height', height + 'px');
      };
      $("#node-input-route-container").sortable({
        axis: 'y',
        update: function (event, ui) {
          var routes = $("#node-input-route-container").children();
          routes.each(function (i) {
            $(this).find('.node-input-route-index').html(i + 1);
          });
        },
        handle: '.node-input-route-handle',
        cursor: 'move'
      });
      $("#node-input-route-container .node-input-route-handle").disableSelection();
      $("#dialog").on('dialogresize', chartDialogResize);
      $("#dialog").one('dialogopen', function (ev) {
        var size = $("#dialog").dialog('option', 'sizeCache-chart');
        if (size) {
          $("#dialog").dialog('option', 'width', size.width);
          $("#dialog").dialog('option', 'height', size.height);
          chartDialogResize();
        }
      });
      $("#dialog").one('dialogclose', function (ev, ui) {
        $("#dialog").off('dialogresize', chartDialogResize);
      });
    },
    oneditsave: function() {
      var node = this;
      var routes = $("#node-input-route-container").children();
      node.routes = [];
      routes.each(function (i) {
        var route = $(this);
        node.routes.push({
          'key': route.find('.node-input-route-key').val(),
          'legend': route.find('.node-input-route-legend').val()
        });
      });
    },
    onpaletteadd: function () {
      var toolbar = $('<div/>', {'id': 'chart-toolbar'}).html('<div class="btn-group pull-right"><a id="chart-tab-clear" title="clear all" class="btn btn-mini" href="#"><i class="fa fa-trash"></i></a></div>');
      var content = $('<div/>', {'id': 'chart-content'});
      var chartTab = $('<div/>', {'id': 'tab-chart'}).append(toolbar).append(content);
      RED.sidebar.addTab('chart', chartTab);
      //RED.sidebar.show('chart');
      this.handleMetrics = function (t, o) {
        if ($("#tab-chart").css('display') == 'block' && document.hasFocus()) {
          var elemid = 'chart-' + o.id.replace('.', '-');
          if (!document.getElementById(elemid)) {
            var panel = $('<div/>', {'class': 'panel'}).html('<div class="btn-group pull-right"><a id="play-' + elemid + '" title="play" class="btn btn-mini" href="#"><i class="fa fa-play"></i></a><a id="pause-' + elemid + '" title="pause" class="btn btn-mini" href="#"><i class="fa fa-pause"></i></a><a id="refresh-' + elemid + '" title="refresh" class="btn btn-mini" href="#"><i class="fa fa-refresh"></i></a><a id="clear-' + elemid + '" title="clear" class="btn btn-mini" href="#"><i class="fa fa-remove"></i></a></div>');
            var legend = $('<div/>', {'id': 'legend-' + elemid, 'class': 'legend'});
            var chart = $('<div/>', {'id': elemid, 'class': 'tab-chart'}).append(panel).append(legend);
            $('<div/>', {'class': 'chart-box'}).append(chart).appendTo(content);
            $("#" + elemid).on({
              'mouseenter': function () {
                $(this).parents('.chart-box').css('border-left', '8px solid #999').css('border-right', '8px solid #999');
                var n = RED.nodes.node(o.id);
                if (n) {
                  n.highlighted = true;
                  n.dirty = true;
                }
                RED.view.redraw();
              },
              'mouseleave': function () {
                $(this).parents('.chart-box').css('border-left', '').css('border-right', '');
                var n = RED.nodes.node(o.id);
                if (n) {
                  n.highlighted = false;
                  n.dirty = true;
                }
                RED.view.redraw();
              }
            });
            $("#play-" + elemid).on('click', function () {
              changeState({'id': o.id, 'name': o.name}, 'enable');
            });
            $("#pause-" + elemid).on('click', function () {
              changeState({'id': o.id, 'name': o.name}, 'disable');
            });
            $("#refresh-" + elemid).on('click', function () {
              changeState({'id': o.id, 'name': o.name}, 'refresh');
            });
            $("#clear-" + elemid).on('click', function () {
              clearChart({'id': o.id, 'name': o.name});
            });
          }
          for (var i = 0; i < o.data.length; i++) {
            o.data[i].date = new Date(o.data[i].date);
          }
          o.chartOption.data = o.data.map(function(d) {return d});
          o.chartOption.legend_target = '#legend-' + elemid;
          o.chartOption.target = '#' + elemid;
          console.log(o.chartOption.data);
          MG.data_graphic(o.chartOption);
        }
      };
      RED.comms.subscribe('chart', this.handleMetrics);
      $("#chart-tab-clear").click(function () {
        $(".chart-box").remove();
        RED.nodes.eachNode(function(node) {
          node.highlighted = false;
          node.dirty = true;
        });
        RED.view.redraw();
      });
    },
    onpaletteremove: function () {
      RED.comms.unsubscribe('chart', this.handleMetrics);
      RED.sidebar.removeTab('chart');
      delete RED._chart;
    }
  });

  function changeState (node, state) {
    d3.xhr("metricsgraphics/" + node.id + "/" + state).post(function (err, resp) {
      if (err) {
        if (err.status == 404) {
          RED.notify("<strong>Error</strong>: debug node not deployed", "error");
        } else if (err.status == 0) {
          RED.notify("<strong>Error</strong>: no response from server", "error");
        } else {
          RED.notify("<strong>Error</strong>: unexpected error: (" + err.status + ")" + err.response, "error");
        }
      } else if (resp.status == 200) {
        RED.notify("Successfully activated: " + node.name, "success");
      } else if (resp.status == 201) {
        RED.notify("Successfully deactivated: " + node.name, "success");
      } else if (resp.status == 202) {
        RED.notify("Successfully refreshed: " + node.name, "success");
      } else {
        RED.notify("<strong>Error</strong>: unexpected response: (" + resp.status + ") " + resp.response, "error");
      }
    });
  }

  function clearChart (node) {
    var elemid = 'chart-' + node.id.replace('.', '-');
    $("#" + elemid).parents('.chart-box').remove();
    var n = RED.nodes.node(node.id);
    n.highlighted = false;
    n.dirty = true;
    RED.view.redraw();
  }
</script>

<style>
  #chart-content {
    width: 100%;
  }

  #chart-toolbar {
    padding: 3px 10px;
    height: 24px;
    background: #f3f3f3;
  }

  .chart-box {
    cursor: pointer;
    position: relative;
    padding: 15px 0px 30px 0px;
    border-bottom: 1px solid #eee;
    border-left: 8px solid #eee;
    border-right: 8px solid #eee;
  }

  .legend {
    position: absolute;
    bottom: 5px;
    width: 100%;
    text-align: center;
    padding: 10px;
  }

  .node-input-route-handle {
    color: #eee;
    cursor: move;
    margin-right: 5px;
  }

  .route-container {
    background: #fff;
    margin:0;
    padding:8px 0px;
    border-bottom: 1px solid #ccc;
  }

  .finalspan {
    float: right;
    margin-right: 10px;
  }

  .editor-button {
    style: margin-top: 7px;
    margin-left: 5px;
  }

  .node-input-route-key, .node-input-route-legend {
    margin-left: 10px;
    width: 150px !important;
  }

  .panel {
    position: absolute;
    top: 10px;
    right: 10px;
  }

.mg-active-datapoint {
    fill: black;
    font-size: 0.7rem;
    font-weight: 400;
    opacity: 0.8;
}

.mg-area1-color {
    fill: #0000ff;
}

.mg-area2-color {
    fill: #05b378;
}

.mg-area3-color {
    fill: #db4437;
}

.mg-area4-color {
    fill: #f8b128;
}

.mg-area5-color {
    fill: #5c5c5c;
}

.mg-barplot rect.mg-bar {
    shape-rendering: auto;
    fill: #b6b6fc;
}

.mg-barplot rect.mg-bar.active {
    fill: #9e9efc;
}

.mg-barplot .mg-bar-prediction {
    fill: #5b5b5b;
}

.mg-barplot .mg-bar-baseline {
    stroke: #5b5b5b;
    stroke-width: 2;
}

.mg-baselines line {
    opacity: 1;
    shape-rendering: auto;
    stroke: #b3b2b2;
    stroke-width: 1px;
}

.mg-baselines text {
    fill: black;
    font-size: 0.7rem;
    opacity: 0.5;
    stroke: none;
}

.mg-baselines-small text {
    font-size: 0.6rem;
}

.mg-chart-title .popover {
    font-size: 0.95rem;
}

.mg-chart-title .popover-content {
    cursor: auto;
    line-height: 17px;
}

.mg-chart-title .popover.top,
.mg-data-table .popover.top {
    margin-top: 0;
}

.mg-chart-title {
    cursor: default;
    font-size: 1.0rem;
    font-weight: normal;
    padding-top: 10px;
    margin-top: 0px;
    margin-bottom: 0px;
    line-height: 0;
    text-align: center;
}

.mg-chart-title .fa {
    color: #ccc;
    font-size: 1.2rem;
    padding-left: 4px;
    vertical-align: top;
}

.mg-chart-title .fa.warning {
    font-weight: 300;
}

.mg-points circle {
    opacity: 0.85;
}

.mg-data-table {
    margin-top: 30px;
}

.mg-data-table thead tr th {
    border-bottom: 1px solid darkgray;
    cursor: default;
    font-size: 1.1rem;
    font-weight: normal;
    padding: 5px 5px 8px 5px;
    text-align: right;
}

.mg-data-table thead tr th .fa {
    color: #ccc;
    padding-left: 4px;
}

.mg-data-table thead tr th .popover {
    font-size: 1rem;
    font-weight: normal;
}

.mg-data-table .secondary-title {
    color: darkgray;
}

.mg-data-table tbody tr td {
    margin: 2px;
    padding: 5px;
    vertical-align: top;
}

.mg-data-table  tbody tr td.table-text {
    opacity: 0.8;
    padding-left: 30px;
}

.mg-y-axis line.mg-extended-y-ticks {
    opacity: 0.4;
}

.mg-x-axis line.mg-extended-x-ticks {
    opacity: 0.4;
}

.mg-histogram .axis path,
.mg-histogram .axis line {
    fill: none;
    opacity: 0.7;
    shape-rendering: auto;
    stroke: #ccc;
}

.mg-histogram .mg-bar rect {
    fill: #b6b6fc;
    shape-rendering: auto;
}

.mg-histogram .mg-bar rect.active {
    fill: #9e9efc;
}

.mg-least-squares-line {
    stroke: red;
    stroke-width: 1px;
}

.mg-lowess-line {
    fill: none;
    stroke: red;
}

.mg-line1-color {
    stroke: #4040e8;
}

.mg-hover-line1-color {
    fill: #4040e8;
}

.mg-line2-color {
    stroke: #05b378;
}

.mg-hover-line2-color {
    fill: #05b378;
}

.mg-line3-color {
    stroke: #db4437;
}

.mg-hover-line3-color {
    fill: #db4437;
}

.mg-line4-color {
    stroke: #f8b128;
}

.mg-hover-line4-color {
    fill: #f8b128;
}

.mg-line5-color {
    stroke: #5c5c5c;
}

.mg-hover-line5-color {
    fill: #5c5c5c;
}

.mg-line-legend text {
    font-size: 0.9rem;
    font-weight: 300;
    stroke: none;
}

.mg-line1-legend-color {
    color: #4040e8;
    fill: #4040e8;
}

.mg-line2-legend-color {
    color: #05b378;
    fill: #05b378;
}

.mg-line3-legend-color {
    color: #db4437;
    fill: #db4437;
}

.mg-line4-legend-color {
    color: #f8b128;
    fill: #f8b128;
}

.mg-line5-legend-color {
    color: #5c5c5c;
    fill: #5c5c5c;
}

.mg-main-area-solid svg .mg-main-area {
    fill: #ccccff;
    opacity: 1;
}

.mg-markers line {
    opacity: 0.9;
    shape-rendering: auto;
    stroke: #b3b2b2;
    stroke-width: 1px;
}

.mg-markers text {
    fill: black;
    font-size: 0.7rem;
    opacity: 0.5;
    stroke: none;
}

.mg-missing-text {
    opacity: 0.9;
}

.mg-missing-background {
    stroke: blue;
    fill: none;
    stroke-dasharray: 10,5;
    stroke-opacity: 0.05;
    stroke-width: 2;
}

.mg-missing .mg-main-line {
    opacity: 0.1;
}

.mg-missing .mg-main-area {
    opacity: 0.03;
}

path.mg-main-area {
    opacity: 0.2;
    stroke: none;
}

path.mg-confidence-band {
    fill: #ccc;
    opacity: 0.4;
    stroke: none;
}

path.mg-main-line {
    fill: none;
    opacity: 0.8;
    stroke-width: 1.1px;
}

.mg-points circle {
    fill-opacity: 0.4;
    stroke-opacity: 1;
}

circle.mg-points-mono {
    fill: #0000ff;
    stroke: #0000ff;
}

/* a selected point in a scatterplot */
.mg-points circle.selected {
    fill-opacity: 1;
    stroke-opacity: 1;
}

.mg-voronoi path {
    fill: none;
    pointer-events: all;
    stroke: none;
    stroke-opacity: 0.1;
}

.mg-x-rug-mono,
.mg-y-rug-mono {
    stroke: black;
}

.mg-x-axis line,
.mg-y-axis line {
    opacity: 1;
    shape-rendering: auto;
    stroke: #b3b2b2;
    stroke-width: 1px;
}

.mg-x-axis text,
.mg-y-axis text,
.mg-histogram .axis text {
    fill: black;
    font-size: 0.7rem;
    opacity: 0.5;
}

.mg-x-axis .label,
.mg-y-axis .label,
.mg-axis .label {
    font-size: 0.8rem;
    text-transform: uppercase;
    font-weight: 400;
}

.mg-x-axis-small text,
.mg-y-axis-small text,
.mg-active-datapoint-small {
    font-size: 0.6rem;
}

.mg-x-axis-small .label,
.mg-y-axis-small .label {
    font-size: 0.65rem;
}

.mg-year-marker text {
    fill: black;
    font-size: 0.7rem;
    opacity: 0.5;
}

.mg-year-marker line {
    opacity: 1;
    shape-rendering: auto;
    stroke: #b3b2b2;
    stroke-width: 1px;
}

.mg-year-marker-small text {
    font-size: 0.6rem;
}

  
</style>